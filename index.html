<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Dietas Pro IA ‚Äî Definitivo (Recetas Offline)</title>

  <!-- ‚úÖ Bootstrap + Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

  <!-- ‚úÖ FullCalendar CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.20/index.global.min.css">

  <!-- ‚úÖ Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg1:#0b1220; --bg2:#111c33;
      --card:rgba(255,255,255,.06);
      --border:rgba(255,255,255,.10);
      --text:#e8eefc; --muted:#94a3b8;
      --shadow:0 14px 30px rgba(0,0,0,.35);
      --accent:#7c3aed;
      --accent2:#22c55e;
      --warn:#f59e0b;
      --info:#60a5fa;
      --danger:#ef4444;
      --glass: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.03));
      --glass2: linear-gradient(135deg, rgba(255,255,255,.12), rgba(255,255,255,.03));
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg1:#f5f8ff; --bg2:#dfeaff;
        --card:#fff; --border:rgba(15,23,42,.12);
        --text:#0f172a; --muted:#64748b;
        --shadow:0 14px 30px rgba(15,23,42,.12);
        --accent:#6d28d9;
        --accent2:#16a34a;
        --warn:#d97706;
        --info:#2563eb;
        --danger:#dc2626;
        --glass: linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,.86));
        --glass2: linear-gradient(135deg, rgba(255,255,255,.95), rgba(255,255,255,.85));
      }
    }

    *{ font-family: Inter, system-ui, -apple-system, Segoe UI, sans-serif; }
    body{
      background: radial-gradient(900px 600px at 20% 10%, rgba(124,58,237,.28), transparent 55%),
                  radial-gradient(700px 500px at 85% 20%, rgba(34,197,94,.18), transparent 55%),
                  linear-gradient(135deg, var(--bg1), var(--bg2));
      color: var(--text);
      min-height:100vh;
    }

    .shell{
      max-width: 1400px;
      margin: 0 auto;
      padding: 16px;
      display:grid;
      grid-template-columns: 300px 1fr;
      gap: 16px;
    }
    @media (max-width: 1024px){ .shell{ grid-template-columns: 1fr; } }

    .sidebar{
      border:1px solid var(--border);
      background: var(--glass);
      border-radius:18px;
      box-shadow: var(--shadow);
      padding: 12px;
      position: sticky;
      top: 16px;
      height: calc(100vh - 32px);
      overflow:auto;
      backdrop-filter: blur(10px);
    }
    @media (max-width: 1024px){ .sidebar{ position: relative; height:auto; } }

    .brandbar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding: 8px 6px 12px;
      border-bottom: 1px solid var(--border);
      margin-bottom: 10px;
    }
    .brandbar .name{ font-weight:900; letter-spacing:.2px; }

    .pill{
      font-size:.84rem;
      border-radius:999px;
      border:1px solid var(--border);
      padding:.25rem .6rem;
      background: rgba(255,255,255,.06);
      color: var(--text);
    }

    .navbtn{
      width:100%;
      text-align:left;
      border-radius: 14px;
      border:1px solid transparent;
      padding: 10px 12px;
      background: transparent;
      color: var(--text);
      display:flex;
      gap:10px;
      align-items:center;
      transition: .15s ease;
    }
    .navbtn:hover{ background: rgba(255,255,255,.07); border-color: var(--border); }
    .navbtn.active{ background: rgba(124,58,237,.18); border-color: rgba(124,58,237,.35); }

    .main{ display:flex; flex-direction:column; gap: 16px; }

    .topbar{
      border:1px solid var(--border);
      background: var(--glass2);
      border-radius:18px;
      box-shadow: var(--shadow);
      padding: 14px 16px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap: 12px;
      flex-wrap:wrap;
      backdrop-filter: blur(10px);
    }

    .cardx{
      border:1px solid var(--border);
      background: var(--glass);
      border-radius:18px;
      box-shadow: var(--shadow);
      padding: 16px;
      backdrop-filter: blur(10px);
    }

    .muted{ color: var(--muted); }
    .hr{ height:1px; background: var(--border); margin: 14px 0; }

    .form-control, .form-select, textarea{
      background: rgba(255,255,255,.06);
      border: 1px solid var(--border);
      color: var(--text);
      border-radius: 12px;
    }
    .form-control::placeholder, textarea::placeholder{ color: rgba(148,163,184,.75); }
    .form-control:focus, .form-select:focus, textarea:focus{
      border-color: rgba(124,58,237,.55);
      box-shadow: 0 0 0 .2rem rgba(124,58,237,.20);
      background: rgba(255,255,255,.08);
      color: var(--text);
    }

    .btn-accent{
      background: linear-gradient(135deg, var(--accent), rgba(96,165,250,.95));
      border:0;
      color:white;
      font-weight:900;
      border-radius:12px;
      padding: 10px 12px;
    }
    .btn-lite{
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text);
      font-weight: 800;
      border-radius:12px;
      padding: 10px 12px;
    }
    .btn-lite:hover{ background: rgba(255,255,255,.06); }
    .btn-danger-lite{
      background: transparent;
      border: 1px solid rgba(239,68,68,.35);
      color: var(--text);
      font-weight: 800;
      border-radius:12px;
      padding: 10px 12px;
    }
    .btn-danger-lite:hover{ background: rgba(239,68,68,.10); }

    .kpi{
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 12px;
      background: rgba(255,255,255,.05);
    }
    .kpi .big{ font-weight: 900; font-size: 1.2rem; }
    .badge-soft{
      border: 1px solid var(--border);
      background: rgba(255,255,255,.06);
      padding: .2rem .6rem;
      border-radius: 999px;
      font-size: .82rem;
    }

    /* Calendar */
    #calendarWrap{
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 12px;
      background: rgba(255,255,255,.03);
    }
    .fc{
      --fc-border-color: rgba(255,255,255,.12);
      --fc-page-bg-color: transparent;
      --fc-neutral-bg-color: rgba(255,255,255,.04);
      --fc-today-bg-color: rgba(124,58,237,.12);
      --fc-now-indicator-color: rgba(239,68,68,.9);
    }
    .fc .fc-toolbar{ gap: 10px; margin-bottom: 10px !important; flex-wrap: wrap; }
    .fc .fc-toolbar-title{ font-weight: 900; letter-spacing: .2px; font-size: 1.15rem; }
    .fc .fc-button{ border-radius: 12px !important; padding: .50rem .80rem !important; font-weight: 900; }
    .fc .fc-button-primary{
      background: linear-gradient(135deg, var(--accent), rgba(96,165,250,.95)) !important;
      border: 0 !important;
    }
    .fc .fc-timegrid-slot{ height: 48px !important; }
    .fc .fc-timegrid-axis, .fc .fc-timegrid-slot-label{
      font-weight: 900;
      color: var(--muted);
      font-size: .84rem;
    }
    .fc .fc-timegrid-event{
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: 0 10px 20px rgba(0,0,0,.16);
      overflow: hidden;
    }
    .evWrap{ display:flex; flex-direction:column; gap:4px; padding: 8px 10px; }
    .evTop{ display:flex; gap:8px; align-items:center; flex-wrap: wrap; }
    .evBadge{
      display:inline-flex; align-items:center; justify-content:center;
      padding: 2px 10px; border-radius: 999px;
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.14);
      font-weight: 900; font-size: .74rem;
      letter-spacing: .1px;
    }
    .evTime{ font-weight: 900; font-size: .78rem; opacity: .95; }
    .evTitle{ white-space: normal; font-weight: 900; font-size: .94rem; line-height: 1.15; }
    .evPortion{ white-space: normal; font-size: .82rem; line-height: 1.15; opacity: .95; }

    .detailCard{
      border: 1px solid var(--border);
      border-radius: 18px;
      background: rgba(255,255,255,.04);
      padding: 14px;
      height: 100%;
      min-height: 280px;
      position: sticky;
      top: 16px;
      backdrop-filter: blur(10px);
    }
    @media (max-width: 992px){ .detailCard{ position: relative; top:auto; } }
    .detailTitle{ font-weight: 900; font-size: 1.05rem; }
    .detailRow{ border-top: 1px dashed rgba(255,255,255,.14); padding-top: 10px; margin-top: 10px; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

    /* Recipes */
    .recipeGrid{ display:grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
    @media (max-width: 992px){ .recipeGrid{ grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 576px){ .recipeGrid{ grid-template-columns: 1fr; } }
    .recipeCard{
      border:1px solid var(--border);
      background: rgba(255,255,255,.05);
      border-radius: 16px;
      overflow:hidden;
      box-shadow: 0 10px 18px rgba(0,0,0,.10);
      transition: transform .12s ease;
      cursor:pointer;
      padding: 12px;
    }
    .recipeCard:hover{ transform: translateY(-2px); }
    .recipeTitle{ font-weight: 900; line-height: 1.15; }
    .recipeMeta{ font-size:.82rem; color: var(--muted); margin-top: 6px; display:flex; gap:6px; flex-wrap:wrap; }

    .toast-container{ position: fixed; right: 16px; bottom: 16px; z-index: 9999; }
    @media print{
      body{ background:#fff !important; color:#000 !important; }
      .sidebar, .topbar, #viewCalendar, .toast-container, .offcanvas, .modal { display:none !important; }
      .cardx{ box-shadow:none !important; border: 1px solid #ddd !important; }
      .muted{ color:#444 !important; }
    }
  </style>
</head>

<body>
  <div class="shell">
    <aside class="sidebar">
      <div class="brandbar">
        <div class="name">ü•ó Dietas Pro IA <span class="badge-soft ms-1">Definitivo</span></div>
        <span class="pill" id="pillUser">Usuario</span>
      </div>

      <div class="d-grid gap-2">
        <button class="navbtn active" data-view="viewProfile"><i class="bi bi-person-badge"></i> Perfil</button>
        <button class="navbtn" data-view="viewPlan"><i class="bi bi-stars"></i> Generar Plan</button>
        <button class="navbtn" data-view="viewCalendar"><i class="bi bi-calendar-week"></i> Calendario</button>
        <button class="navbtn" data-view="viewItinerary"><i class="bi bi-list-check"></i> Itinerario</button>
        <button class="navbtn" data-view="viewRecipes"><i class="bi bi-journal-text"></i> Recetas (Offline)</button>
      </div>

      <div class="hr"></div>

      <div class="d-grid gap-2">
        <button class="btn btn-lite" id="btnExport"><i class="bi bi-download"></i> Exportar</button>
        <label class="btn btn-lite m-0">
          <i class="bi bi-upload"></i> Importar
          <input type="file" id="fileImport" accept=".json" hidden>
        </label>
        <button class="btn btn-danger-lite" id="btnHardReset"><i class="bi bi-trash3"></i> Reset total</button>
      </div>

      <div class="mt-3 muted small">
       
      </div>
    </aside>

    <main class="main">
      <div class="topbar">
        <div>
          <div style="font-weight:900">Panel Profesional</div>
          <div class="muted"></div>
        </div>
        <div class="d-flex gap-2 flex-wrap align-items-center">
          <span class="pill" id="pillStatus">Sin plan</span>
          <button class="btn btn-accent" id="btnQuickPlan"><i class="bi bi-lightning"></i> Plan r√°pido</button>
        </div>
      </div>

      <!-- PERFIL -->
      <section id="viewProfile" class="cardx">
        <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
          <div>
            <div style="font-weight:900"><i class="bi bi-person-badge"></i> Perfil</div>
            <div class="muted"></div>
          </div>
          <div class="d-flex gap-2">
            <button class="btn btn-lite" id="btnResetProfile"><i class="bi bi-arrow-counterclockwise"></i> Reset</button>
            <button class="btn btn-accent" id="btnSaveProfile"><i class="bi bi-save2"></i> Guardar</button>
          </div>
        </div>

        <div class="hr"></div>

        <div class="row g-3">
          <div class="col-lg-4">
            <label class="form-label">Nombre</label>
            <input class="form-control" id="name" placeholder="Tu nombre">
          </div>
          <div class="col-lg-2 col-md-4">
            <label class="form-label">Sexo</label>
            <select class="form-select" id="sex">
              <option value="M">M</option>
              <option value="F">F</option>
            </select>
          </div>
          <div class="col-lg-2 col-md-4">
            <label class="form-label">Edad</label>
            <input class="form-control" id="age" type="number" min="10" max="100">
          </div>
          <div class="col-lg-2 col-md-4">
            <label class="form-label">Estatura (cm)</label>
            <input class="form-control" id="height" type="number" min="120" max="230">
          </div>
          <div class="col-lg-2">
            <label class="form-label">Peso (kg)</label>
            <input class="form-control" id="weight" type="number" min="30" max="300" step="0.1">
          </div>

          <div class="col-lg-4">
            <label class="form-label">Actividad</label>
            <select class="form-select" id="activity">
              <option value="baja">Baja</option>
              <option value="ligera">Ligera</option>
              <option value="moderada" selected>Moderada</option>
              <option value="alta">Alta</option>
              <option value="muy_alta">Muy alta</option>
            </select>
          </div>

          <div class="col-lg-4">
            <label class="form-label">Objetivo</label>
            <select class="form-select" id="goal">
              <option value="bajar">Bajar</option>
              <option value="mantener" selected>Mantener</option>
              <option value="subir">Subir</option>
            </select>
          </div>

          <div class="col-lg-4">
            <label class="form-label">Estilo</label>
            <select class="form-select" id="style">
              <option value="balanceada" selected>Balanceada</option>
              <option value="alto_proteina">Alta prote√≠na</option>
              <option value="keto">Keto</option>
              <option value="vegetariana">Vegetariana</option>
            </select>
          </div>

          <div class="col-lg-6">
            <label class="form-label">Alergias (coma)</label>
            <input class="form-control" id="allergies" placeholder="ej: lactosa, cacahuate">
          </div>
          <div class="col-lg-6">
            <label class="form-label">No me gusta (coma)</label>
            <input class="form-control" id="dislikes" placeholder="ej: pescado, br√≥coli">
          </div>
        </div>

        <div class="hr"></div>

        <div class="row g-3">
          <div class="col-lg-4"><div class="kpi"><div class="muted">BMR</div><div class="big" id="kBMR">‚Äî</div></div></div>
          <div class="col-lg-4"><div class="kpi"><div class="muted">TDEE</div><div class="big" id="kTDEE">‚Äî</div></div></div>
          <div class="col-lg-4"><div class="kpi"><div class="muted">Calor√≠as objetivo</div><div class="big" id="kCAL">‚Äî</div></div></div>
        </div>

        <div class="hr"></div>

        <div class="row g-3">
          <div class="col-lg-6">
            <div class="kpi">
              <div style="font-weight:900">Macros estimados (g)</div>
              <div class="d-flex flex-wrap gap-2 mt-2">
                <span class="badge-soft">üí™ Prote√≠na: <b id="mProt">‚Äî</b></span>
                <span class="badge-soft">üçû Carbos: <b id="mCarb">‚Äî</b></span>
                <span class="badge-soft">ü•ë Grasas: <b id="mFat">‚Äî</b></span>
              </div>
              <div class="muted small mt-2">Estimaci√≥n educativa.</div>
            </div>
          </div>
          <div class="col-lg-6">
            <div class="kpi">
              <div style="font-weight:900">Gr√°fica</div>
              <canvas id="macroChart" style="max-height: 220px; margin-top: 6px;"></canvas>
              <div class="muted small mt-2" id="chartHint">Si la gr√°fica no carga, la app sigue funcionando.</div>
            </div>
          </div>
        </div>
      </section>

      <!-- PLAN -->
      <section id="viewPlan" class="cardx d-none">
        <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
          <div>
            <div style="font-weight:900"><i class="bi bi-stars"></i> Generar Plan</div>
            <div class="muted"></div>
          </div>
          <div class="d-flex gap-2 flex-wrap">
            <button class="btn btn-lite" id="btnExportPlan"><i class="bi bi-download"></i> Exportar plan</button>
            <button class="btn btn-danger-lite" id="btnClearPlan"><i class="bi bi-trash"></i> Limpiar</button>
            <button class="btn btn-accent" id="btnGeneratePlan"><i class="bi bi-magic"></i> Generar</button>
          </div>
        </div>

        <div class="hr"></div>

        <div class="row g-3">
          <div class="col-lg-4">
            <div class="kpi">
              <div style="font-weight:900">üõí Lista del s√∫per (aprox)</div>
              <div class="muted small">Estimado desde porciones.</div>
              <div class="mt-2" id="groceryOut"></div>
            </div>
            <div class="kpi mt-3">
              <div style="font-weight:900">üç≥ Recetas Offline</div>
              <div class="muted small mt-1">Filtradas por estilo/alergias/kcal.</div>
              <div class="d-grid gap-2 mt-2">
                <button class="btn btn-lite" id="btnOpenRecipesFromPlan"><i class="bi bi-journal-text"></i> Abrir Recetas</button>
              </div>
            </div>
          </div>

          <div class="col-lg-8">
            <div class="kpi">
              <div style="font-weight:900">üìÖ Plan semanal (con porciones + bot√≥n Recetas)</div>
              <div class="muted small">Cada comida tiene bot√≥n ‚ÄúRecetas‚Äù (offline).</div>
              <div class="mt-2" id="planOut"></div>
            </div>
          </div>
        </div>
      </section>

      <!-- CALENDARIO -->
      <section id="viewCalendar" class="cardx d-none">
        <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
          <div>
            <div style="font-weight:900"><i class="bi bi-calendar-week"></i> Calendario</div>
            <div class="muted" id="calendarSubtitle">Calendario PRO si FullCalendar carga; si no, modo b√°sico.</div>
          </div>
          <div class="d-flex gap-2 flex-wrap">
            <button class="btn btn-lite" id="btnToday"><i class="bi bi-calendar2-event"></i> Hoy</button>
            <button class="btn btn-lite" id="btnReloadFromPlan"><i class="bi bi-arrow-repeat"></i> Recargar del plan</button>
          </div>
        </div>

        <div class="hr"></div>

        <div id="calendarWarning" class="alert alert-warning d-none rounded-4">
          <b>FullCalendar no carg√≥.</b> Activ√© el <b>Calendario B√°sico</b>.
        </div>

        <div class="row g-3">
          <div class="col-lg-9">
            <div id="calendarWrap">
              <div id="calendar"></div>
              <div id="miniCalendar" class="d-none"></div>
            </div>
          </div>

          <div class="col-lg-3 d-none d-lg-block">
            <div class="detailCard">
              <div class="d-flex justify-content-between align-items-start gap-2">
                <div>
                  <div class="detailTitle">üßæ Detalles</div>
                  <div class="muted small">Click en un evento para ver todo.</div>
                </div>
                <span class="badge-soft" id="detailDate">‚Äî</span>
              </div>

              <div class="detailRow">
                <div class="muted small">Tipo</div>
                <div id="detailType" style="font-weight:900">‚Äî</div>
              </div>

              <div class="detailRow">
                <div class="muted small">Hora</div>
                <div id="detailTime" class="mono" style="font-weight:900">‚Äî</div>
              </div>

              <div class="detailRow">
                <div class="muted small">Comida</div>
                <div id="detailMeal" style="font-weight:900">‚Äî</div>
              </div>

              <div class="detailRow">
                <div class="muted small">Porci√≥n</div>
                <div id="detailPortion">‚Äî</div>
              </div>

              <div class="detailRow d-grid gap-2">
                <button class="btn btn-lite" id="btnDetailRecipes"><i class="bi bi-journal-text"></i> Recetas</button>
                <button class="btn btn-lite" id="btnEditEvent"><i class="bi bi-pencil"></i> Editar</button>
                <button class="btn btn-lite" id="btnMoveEvent"><i class="bi bi-arrows-move"></i> Mover</button>
                <button class="btn btn-danger-lite" id="btnDeleteEvent"><i class="bi bi-x-lg"></i> Borrar</button>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- ITINERARIO -->
      <section id="viewItinerary" class="cardx d-none">
        <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
          <div>
            <div style="font-weight:900"><i class="bi bi-list-check"></i> Itinerario</div>
            <div class="muted">Agenda desde calendario o desde plan.</div>
          </div>
          <button class="btn btn-lite" id="btnPrint"><i class="bi bi-printer"></i> Imprimir</button>
        </div>
        <div class="hr"></div>
        <div id="itineraryOut" class="muted">Genera un plan para ver itinerario.</div>
      </section>

      <!-- RECETAS (OFFLINE) -->
      <section id="viewRecipes" class="cardx d-none">
        <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
          <div>
            <div style="font-weight:900"><i class="bi bi-journal-text"></i> Recetas Offline</div>
            <div class="muted"></div>
          </div>
          <div class="d-flex gap-2 flex-wrap">
            <button class="btn btn-lite" id="btnAddRecipe"><i class="bi bi-plus-circle"></i> Nueva receta</button>
            <button class="btn btn-danger-lite" id="btnResetRecipes"><i class="bi bi-trash"></i> Reset Mis recetas</button>
          </div>
        </div>

        <div class="hr"></div>

        <div class="row g-3">
          <div class="col-lg-4">
            <div class="kpi">
              <div style="font-weight:900">Filtro</div>
              <div class="row g-2 mt-1">
                <div class="col-12">
                  <label class="form-label">Buscar</label>
                  <input class="form-control" id="recipeSearch" placeholder="ej: pollo, ensalada, lentejas">
                </div>
                <div class="col-6">
                  <label class="form-label">Comida</label>
                  <select class="form-select" id="recipeMealKey">
                    <option value="">Todas</option>
                    <option value="desayuno">Desayuno</option>
                    <option value="snack1">Snack</option>
                    <option value="comida">Comida</option>
                    <option value="snack2">Snack</option>
                    <option value="cena">Cena</option>
                  </select>
                </div>
                <div class="col-6">
                  <label class="form-label">Dieta</label>
                  <select class="form-select" id="recipeDiet">
                    <option value="">Todas</option>
                    <option value="balanceada">Balanceada</option>
                    <option value="alto_proteina">Alta prote√≠na</option>
                    <option value="keto">Keto</option>
                    <option value="vegetariana">Vegetariana</option>
                  </select>
                </div>
                <div class="col-12">
                  <label class="form-label">M√°x kcal (opcional)</label>
                  <input class="form-control" id="recipeMaxKcal" type="number" min="0" placeholder="ej: 550">
                </div>
                <div class="col-12 d-grid">
                  <button class="btn btn-accent" id="btnApplyRecipeFilter"><i class="bi bi-funnel"></i> Aplicar</button>
                </div>
              </div>
              <div class="muted small mt-2">Alergias/dislikes del perfil tambi√©n filtran.</div>
            </div>
          </div>

          <div class="col-lg-8">
            <div class="kpi">
              <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                <div style="font-weight:900">Listado</div>
                <span class="badge-soft" id="recipeCount">0</span>
              </div>
              <div class="hr"></div>
              <div id="recipesOut">‚Äî</div>
            </div>
          </div>
        </div>
      </section>

    </main>
  </div>

  <!-- Mobile Offcanvas -->
  <div class="offcanvas offcanvas-bottom" tabindex="-1" id="eventSheet" aria-labelledby="eventSheetLabel"
       style="height: 62vh; border-top-left-radius:18px; border-top-right-radius:18px;">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title" id="eventSheetLabel" style="font-weight:900">üßæ Detalles</h5>
      <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Cerrar"></button>
    </div>
    <div class="offcanvas-body">
      <div class="d-flex justify-content-between flex-wrap gap-2">
        <span class="badge-soft" id="sheetDate">‚Äî</span>
        <span class="badge-soft" id="sheetType">‚Äî</span>
      </div>

      <div class="hr"></div>

      <div class="kpi">
        <div class="muted small">Hora</div>
        <div class="mono" id="sheetTime" style="font-weight:900">‚Äî</div>
        <div class="hr"></div>
        <div class="muted small">Comida</div>
        <div id="sheetMeal" style="font-weight:900">‚Äî</div>
        <div class="hr"></div>
        <div class="muted small">Porci√≥n</div>
        <div id="sheetPortion">‚Äî</div>
      </div>

      <div class="d-grid gap-2 mt-3">
        <button class="btn btn-lite" id="btnDetailRecipesM"><i class="bi bi-journal-text"></i> Recetas</button>
        <button class="btn btn-lite" id="btnEditEventM"><i class="bi bi-pencil"></i> Editar</button>
        <button class="btn btn-lite" id="btnMoveEventM"><i class="bi bi-arrows-move"></i> Mover</button>
        <button class="btn btn-danger-lite" id="btnDeleteEventM"><i class="bi bi-x-lg"></i> Borrar</button>
      </div>
    </div>
  </div>

  <!-- Modal: Edit/Move Event -->
  <div class="modal fade" id="eventModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content" style="background: var(--glass2); border:1px solid var(--border); color: var(--text); border-radius:18px;">
        <div class="modal-header" style="border-bottom: 1px solid var(--border);">
          <h5 class="modal-title" id="eventModalTitle" style="font-weight:900">Editar evento</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3" id="modalTitleRow">
            <label class="form-label">T√≠tulo / Comida</label>
            <input class="form-control" id="modalTitleInput" placeholder="Ej: Pollo con ensalada">
          </div>
          <div class="row g-2" id="modalDateTimeRow">
            <div class="col-6">
              <label class="form-label">Fecha</label>
              <input class="form-control" type="date" id="modalDateInput">
            </div>
            <div class="col-6">
              <label class="form-label">Hora</label>
              <input class="form-control" type="time" id="modalTimeInput">
            </div>
          </div>
        </div>
        <div class="modal-footer" style="border-top: 1px solid var(--border);">
          <button class="btn btn-lite" data-bs-dismiss="modal">Cancelar</button>
          <button class="btn btn-accent" id="modalSaveBtn"><i class="bi bi-check2"></i> Guardar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Recetas (selector + detalle) -->
  <div class="modal fade" id="recipesModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content" style="background: var(--glass2); border:1px solid var(--border); color: var(--text); border-radius:18px;">
        <div class="modal-header" style="border-bottom: 1px solid var(--border);">
          <div>
            <h5 class="modal-title" id="recipesModalTitle" style="font-weight:900">üç≥ Recetas Offline</h5>
            <div class="muted small" id="recipesModalSub">Sin APIs. Filtrado por estilo/kcal/alergias.</div>
          </div>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>

        <div class="modal-body">
          <div class="d-flex gap-2 flex-wrap align-items-center mb-3">
            <input class="form-control" id="recipeQuery" placeholder="Buscar (opcional)" style="max-width:520px;">
            <select class="form-select" id="recipeQueryMeal" style="max-width:220px;">
              <option value="">Todas</option>
              <option value="desayuno">Desayuno</option>
              <option value="snack1">Snack</option>
              <option value="comida">Comida</option>
              <option value="snack2">Snack</option>
              <option value="cena">Cena</option>
            </select>
            <button class="btn btn-accent" id="btnSearchRecipes"><i class="bi bi-search"></i> Buscar</button>
            <span class="badge-soft" id="recipesCount">0</span>
          </div>

          <div class="row g-3">
            <div class="col-lg-6">
              <div class="kpi">
                <div style="font-weight:900">Resultados</div>
                <div class="hr"></div>
                <div id="recipesOutModal" class="muted small">‚Äî</div>
              </div>
            </div>

            <div class="col-lg-6">
              <div class="kpi">
                <div class="d-flex justify-content-between flex-wrap gap-2">
                  <div style="font-weight:900">Detalle</div>
                  <span class="badge-soft" id="recipeDetailTag">‚Äî</span>
                </div>
                <div class="hr"></div>
                <div id="recipeDetailOut" class="muted small">Selecciona una receta.</div>
              </div>
            </div>
          </div>
        </div>

        <div class="modal-footer" style="border-top: 1px solid var(--border);">
          <button class="btn btn-lite" data-bs-dismiss="modal">Cerrar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Nueva Receta -->
  <div class="modal fade" id="addRecipeModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content" style="background: var(--glass2); border:1px solid var(--border); color: var(--text); border-radius:18px;">
        <div class="modal-header" style="border-bottom: 1px solid var(--border);">
          <h5 class="modal-title" style="font-weight:900">‚ûï Nueva receta (Mis recetas)</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>

        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-8">
              <label class="form-label">Nombre</label>
              <input class="form-control" id="newR_name" placeholder="Ej: Ensalada de pollo con aguacate">
            </div>
            <div class="col-md-4">
              <label class="form-label">Kcal aprox</label>
              <input class="form-control" id="newR_kcal" type="number" min="0" placeholder="ej: 520">
            </div>

            <div class="col-md-6">
              <label class="form-label">Tipo de comida</label>
              <select class="form-select" id="newR_mealKey">
                <option value="desayuno">Desayuno</option>
                <option value="snack1">Snack</option>
                <option value="comida">Comida</option>
                <option value="snack2">Snack</option>
                <option value="cena">Cena</option>
              </select>
            </div>

            <div class="col-md-6">
              <label class="form-label">Compatible con dietas</label>
              <div class="d-flex flex-wrap gap-2">
                <label class="badge-soft"><input type="checkbox" class="me-1 dietChk" value="balanceada" checked> Balanceada</label>
                <label class="badge-soft"><input type="checkbox" class="me-1 dietChk" value="alto_proteina"> Alta prote√≠na</label>
                <label class="badge-soft"><input type="checkbox" class="me-1 dietChk" value="keto"> Keto</label>
                <label class="badge-soft"><input type="checkbox" class="me-1 dietChk" value="vegetariana"> Vegetariana</label>
              </div>
            </div>

            <div class="col-12">
              <label class="form-label">Ingredientes (uno por l√≠nea)</label>
              <textarea class="form-control" id="newR_ingredients" rows="5" placeholder="Ej:\n200g pechuga\n1 aguacate\n2 tazas lechuga"></textarea>
            </div>
            <div class="col-12">
              <label class="form-label">Preparaci√≥n (uno por l√≠nea)</label>
              <textarea class="form-control" id="newR_steps" rows="5" placeholder="Ej:\nCocer el pollo\nPicar vegetales\nMezclar y servir"></textarea>
            </div>

            <div class="col-12">
              <label class="form-label">Etiquetas (coma)</label>
              <input class="form-control" id="newR_tags" placeholder="ej: r√°pido, econ√≥mico, mealprep">
            </div>
          </div>
          <div class="muted small mt-2">Tus recetas se guardan en el navegador.</div>
        </div>

        <div class="modal-footer" style="border-top: 1px solid var(--border);">
          <button class="btn btn-lite" data-bs-dismiss="modal">Cancelar</button>
          <button class="btn btn-accent" id="btnSaveNewRecipe"><i class="bi bi-check2"></i> Guardar receta</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast-container">
    <div id="appToast" class="toast align-items-center text-bg-dark border-0" role="alert" aria-live="assertive" aria-atomic="true"
         style="border-radius: 16px; box-shadow: var(--shadow); background: rgba(0,0,0,.55)!important;">
      <div class="d-flex">
        <div class="toast-body" id="toastMsg">Listo</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Cerrar"></button>
      </div>
    </div>
  </div>

  <!-- ‚úÖ Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- =========================
       Loader de librer√≠as (CDN fallback)
       ========================= -->
  <script>
    function loadScript(url){
      return new Promise((resolve, reject)=>{
        const s = document.createElement("script");
        s.src = url;
        s.async = true;
        s.onload = resolve;
        s.onerror = ()=> reject(new Error("No se pudo cargar: " + url));
        document.head.appendChild(s);
      });
    }
    async function trySequence(urls){
      for(const url of urls){
        try { await loadScript(url); return true; } catch(e){ }
      }
      return false;
    }
    async function loadFullCalendarGlobal(){
      const ok = await trySequence([
        "https://cdn.jsdelivr.net/npm/fullcalendar@6.1.20/index.global.min.js",
        "https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/6.1.19/index.global.min.js",
        "https://unpkg.com/fullcalendar@6.1.20/index.global.min.js"
      ]);
      if(!ok || !window.FullCalendar) return false;

      await trySequence([
        "https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.20/locales-all.global.min.js",
        "https://unpkg.com/@fullcalendar/core@6.1.20/locales-all.global.min.js"
      ]);
      await trySequence([
        "https://cdn.jsdelivr.net/npm/@fullcalendar/bootstrap5@6.1.20/index.global.min.js",
        "https://unpkg.com/@fullcalendar/bootstrap5@6.1.20/index.global.min.js"
      ]);
      return true;
    }
    async function loadChart(){
      const ok = await trySequence([
        "https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js",
        "https://unpkg.com/chart.js@4.4.1/dist/chart.umd.min.js",
        "https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"
      ]);
      return !!(ok && window.Chart);
    }
  </script>

  <!-- =========================
       App principal
       ========================= -->
  <script>
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
    const isMobile = () => window.matchMedia("(max-width: 768px)").matches;

    const Store = {
      keys: {
        profile:"dp_profile_v12",
        plan:"dp_plan_v12",
        calendar:"dp_calendar_v12",
        userRecipes:"dp_user_recipes_v12"
      },
      get(k, fallback){ try{ const raw = localStorage.getItem(k); return raw ? JSON.parse(raw) : fallback; } catch(e){ return fallback; } },
      set(k, v){ localStorage.setItem(k, JSON.stringify(v)); },
      del(k){ localStorage.removeItem(k); }
    };

    const App = {
      calendar: null,
      macroChart: null,
      fullcalendarOk: false,
      chartOk: false,
      selectedEvent: null,
      profile: null,
      plan: null,

      builtInRecipes: [],
      userRecipes: [],
      currentRecipeResults: [],
      currentRecipeContext: { query:"", mealKey:"", kcalTarget:0, style:"" },

      showView(id){
        $$("section[id^='view']").forEach(s => s.classList.add("d-none"));
        $("#"+id).classList.remove("d-none");
        $$(".navbtn").forEach(b => b.classList.remove("active"));
        $(`.navbtn[data-view='${id}']`).classList.add("active");
        window.scrollTo({top:0, behavior:"smooth"});
        if(id === "viewCalendar") setTimeout(()=> App.calendar?.updateSize?.(), 120);
        if(id === "viewItinerary") renderItinerary();
        if(id === "viewRecipes") renderRecipesPage();
      }
    };

    function toast(msg){
      $("#toastMsg").textContent = msg;
      const t = bootstrap.Toast.getOrCreateInstance($("#appToast"), { delay: 1700 });
      t.show();
    }

    function esc(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
    function safeNum(v, d=0){ const n = Number(v); return Number.isFinite(n) ? n : d; }
    function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

    function ymdLocal(date){
      const y = date.getFullYear();
      const m = String(date.getMonth()+1).padStart(2,"0");
      const d = String(date.getDate()).padStart(2,"0");
      return `${y}-${m}-${d}`;
    }
    function mondayOfWeek(d=new Date()){
      const x = new Date(d);
      x.setHours(0,0,0,0);
      const day = (x.getDay()+6)%7;
      x.setDate(x.getDate()-day);
      return x;
    }
    function addMinutesToISO(isoStart, minutes){
      const dt = new Date(isoStart);
      dt.setMinutes(dt.getMinutes() + minutes);
      const y = dt.getFullYear();
      const m = String(dt.getMonth()+1).padStart(2,"0");
      const d = String(dt.getDate()).padStart(2,"0");
      const hh = String(dt.getHours()).padStart(2,"0");
      const mm = String(dt.getMinutes()).padStart(2,"0");
      return `${y}-${m}-${d}T${hh}:${mm}:00`;
    }

    /* ---------- Nutrici√≥n ---------- */
    const activityMult = { baja:1.2, ligera:1.375, moderada:1.55, alta:1.725, muy_alta:1.9 };

    function mifflin(sex, age, h, w){
      const s = String(sex).toUpperCase().startsWith("M") ? 5 : -161;
      return (10*w) + (6.25*h) - (5*age) + s;
    }
    function tdee(bmr, act){ return bmr * (activityMult[act] || 1.55); }
    function adjustGoal(cal, goal){
      if(goal==="bajar") return cal*0.85;
      if(goal==="subir") return cal*1.10;
      return cal;
    }
    function macrosFromCalories(cal, style){
      let carbs=0.45, prot=0.25, fat=0.30;
      if(style==="keto"){ carbs=0.10; prot=0.25; fat=0.65; }
      if(style==="alto_proteina"){ carbs=0.35; prot=0.35; fat=0.30; }
      if(style==="vegetariana"){ carbs=0.50; prot=0.20; fat=0.30; }
      cal = Math.max(1200, Math.min(4500, cal));
      return {
        calories: Math.round(cal),
        protein_g: Math.round((cal*prot)/4),
        carbs_g: Math.round((cal*carbs)/4),
        fat_g: Math.round((cal*fat)/9)
      };
    }

    /* ---------- Porciones ---------- */
    function portionScale(cal){ return clamp(cal/2000, 0.75, 1.45); }

    function portionsForMeal(mealText, mealKey, macros){
      const cal = macros?.calories || 2000;
      const f = portionScale(cal);
      const base = {
        protein_g: Math.round(150*f),
        carbsCooked_g: Math.round(200*f),
        oatsDry_g: Math.round(55*f),
        yogurt_g: Math.round(200*f),
        fruit_unit: (f>1.2 ? 2 : 1),
        nuts_g: Math.round(20*f),
        avocado_unit: (f>1.15 ? 1 : 0.5),
        eggs: (f>1.15 ? 3 : 2),
        veggies_cups: (f>1.2 ? 3 : 2)
      };
      const t = (mealText||"").toLowerCase();
      if(t.includes("avena")) return `Avena ${base.oatsDry_g} g + yogurt ${base.yogurt_g} g + fruta ${base.fruit_unit} pza`;
      if(t.includes("yogurt") && t.includes("granola")) return `Yogurt ${base.yogurt_g} g + granola ${Math.round(35*f)} g + frutos rojos ${base.fruit_unit} porci√≥n`;
      if(t.includes("omelette") || t.includes("huevos")) return `${base.eggs} huevos + verduras ${base.veggies_cups} tazas + (opcional) 1 cdita aceite`;
      if(t.includes("aguacate")) return `Aguacate ${base.avocado_unit} pza + prote√≠na ligera`;
      if(t.includes("pollo")) return `Pollo ${base.protein_g} g + verduras ${base.veggies_cups} tazas + carbo ${base.carbsCooked_g} g (si aplica)`;
      if(t.includes("salm√≥n") || t.includes("salmon")) return `Salm√≥n ${Math.round(140*f)} g + verduras ${base.veggies_cups} tazas`;
      if(t.includes("at√∫n") || t.includes("atun")) return `At√∫n 1 lata + ensalada ${base.veggies_cups} tazas`;
      if(mealKey==="snack1" || mealKey==="snack2") return `Snack: fruta o yogurt o nueces (porci√≥n)`;
      return `Gu√≠a: prote√≠na ${Math.round(150*f)} g + verduras 2 tazas + carbo (si aplica)`;
    }

    /* ---------- Plan ---------- */
    const MEALS = {
      balanceada:{
        desayuno:["Avena con yogurt y fruta","Omelette con espinaca","Tostadas integrales con aguacate","Yogurt con granola y frutos rojos"],
        comida:["Pollo con arroz integral y ensalada","Salm√≥n con verduras","Tacos de pavo con frijoles","Bowl de arroz con frijol negro y verduras"],
        cena:["Ensalada con at√∫n y garbanzos","Crema de verduras + pan integral","Huevos con verduras","Ensalada grande con pollo"],
        snack:["Manzana + almendras","Yogurt + ch√≠a","Pepino con hummus","Nueces mixtas (porci√≥n)"]
      },
      alto_proteina:{
        desayuno:["Huevos + avena","Yogurt griego + fruta","S√°ndwich integral de pavo","Omelette + queso (moderado)"],
        comida:["Pollo + quinoa + verduras","At√∫n + arroz + ensalada","Carne magra + camote","Pavo + ensalada + arroz"],
        cena:["Ensalada con pollo","Tortilla de claras + verduras","Pavo + verduras","At√∫n + ensalada"],
        snack:["Cottage + fruta","Yogurt griego","Pavo + galletas integrales","Queso fresco (porci√≥n)"]
      },
      keto:{
        desayuno:["Huevos con aguacate","Omelette con queso y champi√±ones","Yogurt griego + nueces"],
        comida:["Salm√≥n con ensalada","Pollo con verduras salteadas","Carne con ensalada + aguacate"],
        cena:["At√∫n con ensalada","Huevos con espinaca","Ensalada con pollo y semillas"],
        snack:["Nueces mixtas","Queso + aceitunas","Pepino con guacamole"]
      },
      vegetariana:{
        desayuno:["Avena con leche vegetal + fruta","Tostadas con aguacate y tomate","Yogurt (o vegetal) + ch√≠a"],
        comida:["Quinoa + garbanzos + verduras","Tacos de frijoles","Lentejas guisadas + ensalada"],
        cena:["Ensalada con tofu o garbanzos","Crema de verduras + pan integral","Omelette (si ovo) + ensalada"],
        snack:["Fruta + nueces","Hummus + verduras","Yogurt + ch√≠a"]
      }
    };

    const DAYS = ["Lunes","Martes","Mi√©rcoles","Jueves","Viernes","S√°bado","Domingo"];
    const MEAL_TIMES = { desayuno:"08:00", snack1:"11:00", comida:"14:00", snack2:"17:00", cena:"20:00" };
    const MEAL_COLORS = { desayuno:"#60a5fa", snack1:"#7c3aed", comida:"#22c55e", snack2:"#7c3aed", cena:"#f59e0b" };
    const LABELS_ES = { desayuno:"ü•£ Desayuno", snack1:"üçè Snack", comida:"üç≤ Comida", snack2:"ü•ú Snack", cena:"üåô Cena" };
    const MEAL_DURATION_MIN = { desayuno:60, snack1:30, comida:75, snack2:30, cena:60 };

    function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
    function normalizeList(s){ return (s||"").split(",").map(x=>x.trim().toLowerCase()).filter(Boolean); }
    function containsAny(text, list){ const t=(text||"").toLowerCase(); return list.some(x=>x && t.includes(x)); }
    function pickSafe(arr, allergies, dislikes){
      for(let i=0;i<12;i++){
        const v = pick(arr);
        if(!containsAny(v, allergies) && !containsAny(v, dislikes)) return v;
      }
      return pick(arr);
    }

    function generateWeekPlan(profile){
      const style = MEALS[profile.style] ? profile.style : "balanceada";
      const db = MEALS[style];
      const allergies = normalizeList(profile.allergies);
      const dislikes  = normalizeList(profile.dislikes);

      return DAYS.map(d => ({
        dia: d,
        desayuno: pickSafe(db.desayuno, allergies, dislikes),
        snack1:   pickSafe(db.snack, allergies, dislikes),
        comida:   pickSafe(db.comida, allergies, dislikes),
        snack2:   pickSafe(db.snack, allergies, dislikes),
        cena:     pickSafe(db.cena, allergies, dislikes)
      }));
    }

    /* ---------- Grocery ---------- */
    function groceryFromWeekWithAmounts(plan){
      if(!plan?.week) return [];
      const cal = plan.macros?.calories || 2000;
      const f = portionScale(cal);
      const totals = new Map();
      const add = (name, qty, unit)=>{
        const key = name.toLowerCase();
        const cur = totals.get(key) || { name, qty:0, unit };
        cur.qty += qty;
        totals.set(key, cur);
      };
      const eachMeal = (mealText)=>{
        const t = (mealText||"").toLowerCase();
        if(t.includes("avena")) add("Avena", Math.round(55*f), "g");
        if(t.includes("yogurt")) add("Yogurt", Math.round(200*f), "g");
        if(t.includes("manzana") || t.includes("fruta") || t.includes("frutos")) add("Fruta", 1, "pza");
        if(t.includes("huevo")) add("Huevo", (f>1.15?3:2), "pza");
        if(t.includes("aguacate")) add("Aguacate", (f>1.15?1:0.5), "pza");
        if(t.includes("pollo")) add("Pollo", Math.round(150*f), "g");
        if(t.includes("pavo")) add("Pavo", Math.round(150*f), "g");
        if(t.includes("salm√≥n") || t.includes("salmon")) add("Salm√≥n", Math.round(140*f), "g");
        if(t.includes("at√∫n") || t.includes("atun")) add("At√∫n", 1, "lata");
        if(t.includes("arroz")) add("Arroz (cocido)", Math.round(200*f), "g");
        if(t.includes("quinoa")) add("Quinoa (cocida)", Math.round(220*f), "g");
        if(t.includes("lentejas")) add("Lentejas (cocidas)", Math.round(260*f), "g");
        if(t.includes("garbanzos")) add("Garbanzos (cocidos)", Math.round(240*f), "g");
        if(t.includes("nueces") || t.includes("almendras")) add("Nueces/almendras", Math.round(20*f), "g");
        if(t.includes("pepino")) add("Pepino", 1, "pza");
        if(t.includes("hummus")) add("Hummus", Math.round(60*f), "g");
        if(t.includes("ensalada") || t.includes("verduras") || t.includes("espinaca")) add("Verduras/ensalada", (f>1.2?3:2), "tazas");
      };
      plan.week.forEach(d=>{
        eachMeal(d.desayuno); eachMeal(d.snack1); eachMeal(d.comida); eachMeal(d.snack2); eachMeal(d.cena);
      });
      return Array.from(totals.values())
        .sort((a,b)=> a.name.localeCompare(b.name))
        .map(x => `${x.name}: ${Math.round(x.qty*10)/10} ${x.unit}`);
    }

    /* ---------- Perfil IO ---------- */
    function defaultProfile(){
      return { name:"Usuario", sex:"M", age:25, height:170, weight:70, activity:"moderada", goal:"mantener", style:"balanceada", allergies:"", dislikes:"" };
    }
    function readProfile(){
      return {
        name: ($("#name").value || "Usuario").trim(),
        sex: $("#sex").value,
        age: safeNum($("#age").value, 25),
        height: safeNum($("#height").value, 170),
        weight: safeNum($("#weight").value, 70),
        activity: $("#activity").value,
        goal: $("#goal").value,
        style: $("#style").value,
        allergies: ($("#allergies").value || "").trim(),
        dislikes: ($("#dislikes").value || "").trim()
      };
    }
    function writeProfile(p){
      $("#name").value = p.name;
      $("#sex").value = p.sex;
      $("#age").value = p.age;
      $("#height").value = p.height;
      $("#weight").value = p.weight;
      $("#activity").value = p.activity;
      $("#goal").value = p.goal;
      $("#style").value = p.style;
      $("#allergies").value = p.allergies || "";
      $("#dislikes").value = p.dislikes || "";
      $("#pillUser").textContent = p.name || "Usuario";
    }

    function updateKPIs(){
      const p = readProfile();
      const b = mifflin(p.sex, p.age, p.height, p.weight);
      const t = tdee(b, p.activity);
      const c = adjustGoal(t, p.goal);
      const m = macrosFromCalories(c, p.style);

      $("#kBMR").textContent = `${Math.round(b)} kcal`;
      $("#kTDEE").textContent = `${Math.round(t)} kcal`;
      $("#kCAL").textContent = `${m.calories} kcal`;
      $("#mProt").textContent = m.protein_g;
      $("#mCarb").textContent = m.carbs_g;
      $("#mFat").textContent = m.fat_g;

      renderMacroChart(m);
      return { bmr:Math.round(b), tdee:Math.round(t), calories:m.calories, macros:m };
    }

    function renderMacroChart(m){
      const canvas = document.getElementById("macroChart");
      if(!canvas || !window.Chart){
        $("#chartHint").textContent = "Gr√°fica no disponible (Chart.js no carg√≥).";
        return;
      }
      $("#chartHint").textContent = "";
      const ctx = canvas.getContext("2d");
      if(App.macroChart) App.macroChart.destroy();
      App.macroChart = new Chart(ctx, {
        type:"doughnut",
        data:{
          labels:["Prote√≠na (g)","Carbos (g)","Grasas (g)"],
          datasets:[{ data:[m.protein_g,m.carbs_g,m.fat_g], backgroundColor:["#22c55e","#60a5fa","#f59e0b"] }]
        },
        options:{ plugins:{ legend:{ position:"bottom" } } }
      });
    }

    /* ---------- Plan render (con bot√≥n Recetas) ---------- */
    function mealRow(time, label, mealKey, mealText, portion){
      return `
        <div class="mb-2 d-flex justify-content-between gap-2 flex-wrap align-items-start">
          <div style="min-width: 64px;"><span class="badge-soft">${esc(time)}</span></div>
          <div style="flex:1;">
            <b>${esc(label)}:</b> ${esc(mealText)}
            <div class="muted">üçΩÔ∏è ${esc(portion)}</div>
          </div>
          <div>
            <button class="btn btn-sm btn-lite"
              data-recipe-q="${esc(mealText)}"
              data-meal-key="${esc(mealKey)}">
              <i class="bi bi-journal-text"></i> Recetas
            </button>
          </div>
        </div>
      `;
    }

    function renderPlan(plan){
      if(!plan){
        $("#planOut").innerHTML = `<div class="muted">Genera un plan para verlo aqu√≠.</div>`;
        $("#groceryOut").innerHTML = `<span class="muted">‚Äî</span>`;
        $("#pillStatus").textContent = "Sin plan";
        return;
      }
      $("#pillStatus").textContent = "Plan activo";

      const grocery = groceryFromWeekWithAmounts(plan);
      $("#groceryOut").innerHTML = grocery.length
        ? `<ul class="m-0 ps-3 small">${grocery.map(x=>`<li>${esc(x)}</li>`).join("")}</ul>`
        : `<span class="muted">‚Äî</span>`;

      const m = plan.macros;
      const html = plan.week.map(d => {
        const bPor  = portionsForMeal(d.desayuno,"desayuno",m);
        const s1Por = portionsForMeal(d.snack1,"snack1",m);
        const cPor  = portionsForMeal(d.comida,"comida",m);
        const s2Por = portionsForMeal(d.snack2,"snack2",m);
        const cePor = portionsForMeal(d.cena,"cena",m);

        return `
          <div class="kpi mb-2">
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
              <div style="font-weight:900">${esc(d.dia)}</div>
              <span class="badge-soft">${esc(m.calories)} kcal/d√≠a</span>
            </div>
            <div class="hr"></div>
            <div class="small">
              ${mealRow("08:00","Desayuno","desayuno",d.desayuno,bPor)}
              ${mealRow("11:00","Snack","snack1",d.snack1,s1Por)}
              ${mealRow("14:00","Comida","comida",d.comida,cPor)}
              ${mealRow("17:00","Snack","snack2",d.snack2,s2Por)}
              ${mealRow("20:00","Cena","cena",d.cena,cePor)}
            </div>
          </div>
        `;
      }).join("");

      $("#planOut").innerHTML = html;

      $$("#planOut button[data-recipe-q]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const q = btn.getAttribute("data-recipe-q") || "";
          const mk = btn.getAttribute("data-meal-key") || "";
          openRecipesModal({ query:q, mealKey:mk });
        });
      });
    }

    /* ---------- Calendario ---------- */
    function getCurrentEvents(){
      if(App.fullcalendarOk && App.calendar){
        return App.calendar.getEvents().map(e => ({
          id: e.id || crypto.randomUUID(),
          title: e.title,
          start: e.startStr,
          end: e.endStr || "",
          backgroundColor: e.backgroundColor || "",
          borderColor: e.borderColor || "",
          extendedProps: e.extendedProps || {}
        }));
      }
      return Store.get(Store.keys.calendar, []);
    }
    function persistCalendar(){ Store.set(Store.keys.calendar, getCurrentEvents()); }

    function buildEventsFromPlan(plan){
      const start = mondayOfWeek(new Date());
      const events = [];
      plan.week.forEach((d, idx) => {
        const date = new Date(start);
        date.setDate(start.getDate()+idx);
        const base = ymdLocal(date);

        ["desayuno","snack1","comida","snack2","cena"].forEach(key => {
          const portion = portionsForMeal(d[key], key, plan.macros);
          const startISO = `${base}T${MEAL_TIMES[key]}:00`;
          const endISO = addMinutesToISO(startISO, MEAL_DURATION_MIN[key] || 45);
          events.push({
            id: crypto.randomUUID(),
            title: d[key],
            start: startISO,
            end: endISO,
            backgroundColor: MEAL_COLORS[key],
            borderColor: "transparent",
            extendedProps: { mealKey:key, portion, rawMeal:d[key] }
          });
        });
      });
      return events;
    }

    function loadCalendarFromStorage(){
      const events = Store.get(Store.keys.calendar, []);
      if(App.fullcalendarOk && App.calendar){
        App.calendar.removeAllEvents();
        events.forEach(ev => App.calendar.addEvent(ev));
      } else {
        renderMiniCalendar();
      }
    }

    function loadCalendarFromPlan(plan){
      const events = buildEventsFromPlan(plan);
      Store.set(Store.keys.calendar, events);
      if(App.fullcalendarOk && App.calendar){
        App.calendar.removeAllEvents();
        events.forEach(ev => App.calendar.addEvent(ev));
      } else {
        renderMiniCalendar();
      }
      persistCalendar();
    }

    function setDetailFromEvent(fcEvent){
      if(!fcEvent) return;
      App.selectedEvent = fcEvent;

      const key = fcEvent.extendedProps?.mealKey || "";
      const label = LABELS_ES[key] || "üçΩÔ∏è Evento";
      const portion = fcEvent.extendedProps?.portion || "";
      const start = fcEvent.start;
      const date = start ? ymdLocal(start) : "‚Äî";
      const time = start ? String(fcEvent.startStr).slice(11,16) : "‚Äî";

      $("#detailDate").textContent = date;
      $("#detailType").textContent = label;
      $("#detailTime").textContent = time;
      $("#detailMeal").textContent = fcEvent.title || "‚Äî";
      $("#detailPortion").textContent = portion || "‚Äî";

      $("#sheetDate").textContent = date;
      $("#sheetType").textContent = label;
      $("#sheetTime").textContent = time;
      $("#sheetMeal").textContent = fcEvent.title || "‚Äî";
      $("#sheetPortion").textContent = portion || "‚Äî";
    }

    function initCalendarIfAvailable(){
      if(!window.FullCalendar){
        App.fullcalendarOk = false;
        $("#calendarWarning").classList.remove("d-none");
        $("#calendarSubtitle").textContent = "Modo b√°sico activo (sin FullCalendar).";
        $("#calendar").style.display = "none";
        $("#miniCalendar").classList.remove("d-none");
        renderMiniCalendar();
        return;
      }

      App.fullcalendarOk = true;
      $("#calendarWarning").classList.add("d-none");
      $("#calendar").style.display = "";
      $("#miniCalendar").classList.add("d-none");

      const hasBootstrapTheme = !!window.FullCalendarBootstrap5;

      App.calendar = new FullCalendar.Calendar($("#calendar"), {
        initialView: isMobile() ? "timeGridDay" : "timeGridWeek",
        height: "auto",
        nowIndicator: true,
        editable: true,
        eventDurationEditable: true,
        allDaySlot: false,
        slotMinTime: "06:00:00",
        slotMaxTime: "22:00:00",

        locale: "es",
        firstDay: 1,
        themeSystem: hasBootstrapTheme ? "bootstrap5" : "standard",

        headerToolbar: isMobile()
          ? { left:"prev,next today", center:"title", right:"timeGridDay,listWeek" }
          : { left:"prev,next today", center:"title", right:"timeGridWeek,dayGridMonth,listWeek" },

        dayHeaderFormat: { weekday:"short", day:"2-digit" },
        slotLabelFormat: { hour:"2-digit", minute:"2-digit", hour12:false },
        eventTimeFormat: { hour:"2-digit", minute:"2-digit", hour12:false },

        eventContent(arg){
          const ek = arg.event.extendedProps?.mealKey || "";
          const label = ek ? (LABELS_ES[ek] || "üçΩÔ∏è") : "üçΩÔ∏è";
          const portion = arg.event.extendedProps?.portion || "";

          const wrap = document.createElement("div");
          wrap.className = "evWrap";
          wrap.innerHTML = `
            <div class="evTop">
              <span class="evBadge">${esc(label)}</span>
              <span class="evTime">${esc(String(arg.timeText || ""))}</span>
            </div>
            <div class="evTitle">${esc(arg.event.title)}</div>
            ${portion ? `<div class="evPortion">üçΩÔ∏è ${esc(portion)}</div>` : ``}
          `;
          return { domNodes: [wrap] };
        },

        eventClick(info){
          setDetailFromEvent(info.event);
          if(isMobile()){
            bootstrap.Offcanvas.getOrCreateInstance($("#eventSheet")).show();
          }
          toast("Detalles ‚úÖ");
        },

        eventDrop(){ persistCalendar(); toast("Evento movido ‚úÖ"); },
        eventResize(){ persistCalendar(); toast("Duraci√≥n actualizada ‚úÖ"); }
      });

      App.calendar.render();
      loadCalendarFromStorage();

      let last = isMobile();
      window.addEventListener("resize", ()=>{
        if(!App.calendar) return;
        const now = isMobile();
        if(now !== last){
          last = now;
          App.calendar.changeView(now ? "timeGridDay" : "timeGridWeek");
          App.calendar.setOption("headerToolbar",
            now
              ? { left:"prev,next today", center:"title", right:"timeGridDay,listWeek" }
              : { left:"prev,next today", center:"title", right:"timeGridWeek,dayGridMonth,listWeek" }
          );
          App.calendar.updateSize();
        }
      });

      const ev = App.calendar.getEvents();
      if(ev && ev[0]) setDetailFromEvent(ev[0]);
      $("#calendarSubtitle").textContent = "";
    }

    function renderMiniCalendar(){
      const container = $("#miniCalendar");
      if(!container) return;

      let events = Store.get(Store.keys.calendar, []);
      if((!events || !events.length) && App.plan){
        events = buildEventsFromPlan(App.plan);
        Store.set(Store.keys.calendar, events);
      }

      const ev = (events || [])
        .map(x => ({...x, _date: (x.start||"").slice(0,10), _time: (x.start||"").slice(11,16) }))
        .filter(x => x._date && x._time)
        .sort((a,b)=> (a.start||"").localeCompare(b.start||""));

      const start = mondayOfWeek(new Date());
      const days = Array.from({length:7}).map((_,i)=>{
        const d = new Date(start); d.setDate(start.getDate()+i);
        return { key: ymdLocal(d), name: d.toLocaleDateString("es-MX",{weekday:"long", day:"2-digit", month:"short"}) };
      });

      const byDay = {}; days.forEach(d=> byDay[d.key]=[]);
      ev.forEach(e=>{ if(byDay[e._date]) byDay[e._date].push(e); });

      container.innerHTML = `
        <div class="d-grid gap-2">
          ${days.map(d=>`
            <div class="kpi">
              <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                <div style="font-weight:900">${esc(d.name)}</div>
                <span class="badge-soft">${esc(d.key)}</span>
              </div>
              <div class="hr"></div>
              ${(byDay[d.key]||[]).map((e)=>`
                <div class="mb-2">
                  <span class="badge-soft">${esc(e._time)}</span>
                  <b class="ms-1">${esc(e.title)}</b>
                  ${e.extendedProps?.portion ? `<div class="muted small mt-1">üçΩÔ∏è ${esc(e.extendedProps.portion)}</div>` : ""}
                </div>
              `).join("") || `<div class="muted small">Sin eventos</div>`}
            </div>
          `).join("")}
        </div>
      `;
    }

    /* ---------- Itinerario ---------- */
    function renderItinerary(){
      const events = Store.get(Store.keys.calendar, []);
      const plan = App.plan;

      if((!events || !events.length) && plan){
        const m = plan.macros;
        const out = plan.week.map(d => `
          <div class="kpi mb-2">
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
              <div style="font-weight:900">${esc(d.dia)}</div>
              <span class="badge-soft">${esc(m.calories)} kcal/d√≠a</span>
            </div>
            <div class="hr"></div>
            <div class="small">
              <div class="mb-2"><span class="badge-soft">08:00</span> <b>DESAYUNO:</b> ${esc(d.desayuno)}<div class="muted">üçΩÔ∏è ${esc(portionsForMeal(d.desayuno,"desayuno",m))}</div></div>
              <div class="mb-2"><span class="badge-soft">11:00</span> <b>SNACK:</b> ${esc(d.snack1)}<div class="muted">üçΩÔ∏è ${esc(portionsForMeal(d.snack1,"snack1",m))}</div></div>
              <div class="mb-2"><span class="badge-soft">14:00</span> <b>COMIDA:</b> ${esc(d.comida)}<div class="muted">üçΩÔ∏è ${esc(portionsForMeal(d.comida,"comida",m))}</div></div>
              <div class="mb-2"><span class="badge-soft">17:00</span> <b>SNACK:</b> ${esc(d.snack2)}<div class="muted">üçΩÔ∏è ${esc(portionsForMeal(d.snack2,"snack2",m))}</div></div>
              <div><span class="badge-soft">20:00</span> <b>CENA:</b> ${esc(d.cena)}<div class="muted">üçΩÔ∏è ${esc(portionsForMeal(d.cena,"cena",m))}</div></div>
            </div>
          </div>
        `).join("");
        $("#itineraryOut").innerHTML = out;
        return;
      }

      if(!events || !events.length){
        $("#itineraryOut").innerHTML = `<div class="muted">No hay eventos. Genera un plan o recarga del plan.</div>`;
        return;
      }

      const ev = events
        .map(e => ({ title:e.title, start:e.start, portion:e.extendedProps?.portion || "" }))
        .filter(x => x.start)
        .sort((a,b)=> String(a.start).localeCompare(String(b.start)));

      const byDay = {};
      ev.forEach(x => {
        const d = String(x.start).slice(0,10);
        (byDay[d] ||= []).push(x);
      });

      const days = Object.keys(byDay).sort();
      const out = days.map(date => {
        const human = new Date(date+"T00:00:00");
        const name = human.toLocaleDateString("es-MX", { weekday:"long", day:"2-digit", month:"short" });

        const rows = byDay[date].map(x => {
          const time = String(x.start).slice(11,16);
          return `
            <div class="d-flex gap-2 align-items-start mb-2">
              <span class="badge-soft">${esc(time)}</span>
              <div>
                <div style="font-weight:900">${esc(x.title)}</div>
                ${x.portion ? `<div class="muted small">üçΩÔ∏è ${esc(x.portion)}</div>` : ``}
              </div>
            </div>
          `;
        }).join("");

        return `<div class="kpi mb-2">
          <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
            <div style="font-weight:900">${esc(name)}</div>
            <span class="badge-soft">${esc(date)}</span>
          </div>
          <div class="hr"></div>
          ${rows}
        </div>`;
      }).join("");

      $("#itineraryOut").innerHTML = out;
    }

    /* ---------- Recetas Offline ---------- */
    function prettyMeal(k){
      return ({desayuno:"Desayuno", snack1:"Snack", snack2:"Snack", comida:"Comida", cena:"Cena"})[k] || k;
    }
    function prettyDiet(d){
      return ({balanceada:"Balanceada", alto_proteina:"Alta prote√≠na", keto:"Keto", vegetariana:"Vegetariana"})[d] || d;
    }

    function seedBuiltInRecipes(){
      const R = [];
      let id = 1;
      const add = (o)=> R.push({ id:id++, ...o, source:"Cat√°logo" });

      // Desayuno
      add({ name:"Avena con pl√°tano y canela", mealKey:"desayuno", diets:["balanceada","vegetariana"], kcal:380,
        tags:["avena","r√°pido"], ingredients:["60 g avena","250 ml leche o bebida vegetal","1 pl√°tano","canela"],
        steps:["Cocina la avena con la leche","Agrega pl√°tano","Espolvorea canela"]});
      add({ name:"Omelette de espinaca", mealKey:"desayuno", diets:["balanceada","alto_proteina","keto"], kcal:420,
        tags:["huevo"], ingredients:["2-3 huevos","1 taza espinaca","sal y pimienta","1 cdita aceite"],
        steps:["Bate huevos","Saltea espinaca","Cocina omelette"]});
      add({ name:"Yogurt con granola y frutos rojos", mealKey:"desayuno", diets:["balanceada"], kcal:390,
        tags:["yogurt"], ingredients:["200 g yogurt","35 g granola","frutos rojos"],
        steps:["Sirve yogurt","Agrega granola","A√±ade frutos rojos"]});
      add({ name:"Huevos con aguacate", mealKey:"desayuno", diets:["keto","alto_proteina"], kcal:460,
        tags:["aguacate"], ingredients:["2-3 huevos","1/2 aguacate","sal"],
        steps:["Cocina huevos","Acompa√±a con aguacate"]});

      // Snacks
      add({ name:"Manzana con almendras", mealKey:"snack1", diets:["balanceada","alto_proteina","vegetariana"], kcal:220,
        tags:["fruta","nueces"], ingredients:["1 manzana","20 g almendras"],
        steps:["Lava manzana","Acompa√±a con almendras"]});
      add({ name:"Pepino con hummus", mealKey:"snack1", diets:["balanceada","vegetariana"], kcal:180,
        tags:["pepino","hummus"], ingredients:["1 pepino","60 g hummus"],
        steps:["Corta pepino","Dipea con hummus"]});
      add({ name:"Nueces mixtas (porci√≥n)", mealKey:"snack2", diets:["keto","balanceada","vegetariana"], kcal:240,
        tags:["nueces"], ingredients:["25 g nueces mixtas"],
        steps:["Sirve porci√≥n","Listo"]});

      // Comida
      add({ name:"Pollo a la plancha con ensalada", mealKey:"comida", diets:["balanceada","alto_proteina","keto"], kcal:520,
        tags:["pollo","ensalada"], ingredients:["180 g pollo","2 tazas ensalada","1 cda aceite de oliva"],
        steps:["Cocina pollo","Mezcla ensalada","Sirve"]});
      add({ name:"Salm√≥n al horno con verduras", mealKey:"comida", diets:["balanceada","alto_proteina","keto"], kcal:590,
        tags:["salm√≥n"], ingredients:["160 g salm√≥n","verduras","lim√≥n"],
        steps:["Hornea salm√≥n 15-20 min","Acompa√±a con verduras"]});
      add({ name:"Quinoa con garbanzos y verduras", mealKey:"comida", diets:["balanceada","vegetariana"], kcal:610,
        tags:["quinoa","garbanzo"], ingredients:["220 g quinoa cocida","240 g garbanzos","verduras"],
        steps:["Mezcla quinoa y garbanzos","Agrega verduras","Ali√±a"]});
      add({ name:"At√∫n con ensalada", mealKey:"comida", diets:["keto","alto_proteina","balanceada"], kcal:480,
        tags:["at√∫n"], ingredients:["1 lata at√∫n","ensalada","1 cda aceite"],
        steps:["Drena at√∫n","Mezcla con ensalada","A√±ade aceite"]});

      // Cena
      add({ name:"Crema de verduras (ligera)", mealKey:"cena", diets:["balanceada","vegetariana"], kcal:360,
        tags:["verduras"], ingredients:["verduras mixtas","caldo","sal"],
        steps:["Hierve verduras","Lic√∫a","Calienta y sirve"]});
      add({ name:"Huevos con espinaca", mealKey:"cena", diets:["keto","alto_proteina","balanceada"], kcal:420,
        tags:["huevo"], ingredients:["2 huevos","espinaca","sal"],
        steps:["Saltea espinaca","Agrega huevos","Cocina"]});
      add({ name:"Ensalada grande con pollo", mealKey:"cena", diets:["balanceada","alto_proteina"], kcal:480,
        tags:["ensalada","pollo"], ingredients:["150 g pollo","ensalada","aderezo ligero"],
        steps:["Cocina pollo","Mezcla ensalada","Sirve"]});

      return R;
    }

    function loadRecipes(){
      App.builtInRecipes = seedBuiltInRecipes();
      App.userRecipes = Store.get(Store.keys.userRecipes, []);
    }
    function saveUserRecipes(){ Store.set(Store.keys.userRecipes, App.userRecipes); }

    function recipeAll(){ return [...App.builtInRecipes, ...App.userRecipes]; }
    function profileExclusions(profile){
      return [...normalizeList(profile.allergies), ...normalizeList(profile.dislikes)];
    }
    function recipeMatchesExclusions(recipe, exclusions){
      if(!exclusions.length) return true;
      const hay = [recipe.name, ...(recipe.tags||[]), ...(recipe.ingredients||[]), ...(recipe.steps||[])].join(" ").toLowerCase();
      return !exclusions.some(x => x && hay.includes(x));
    }
    function mealKcalTarget(plan, mealKey){
      const day = plan?.macros?.calories || 2000;
      const w = { desayuno:0.25, snack1:0.10, comida:0.30, snack2:0.10, cena:0.25 };
      const pct = w[mealKey] ?? 0.20;
      return Math.round(day * pct);
    }
    function scoreRecipe(recipe, ctx){
      let score = 0;
      if(recipe.diets?.includes(ctx.style)) score += 50;
      if(!ctx.mealKey || recipe.mealKey === ctx.mealKey) score += 20;
      const q = (ctx.query||"").toLowerCase().trim();
      if(q){
        const hay = [recipe.name, ...(recipe.tags||[]), ...(recipe.ingredients||[])].join(" ").toLowerCase();
        if(hay.includes(q)) score += 20;
        const toks = q.split(/\s+/).filter(Boolean);
        score += toks.reduce((acc,t)=> acc + (hay.includes(t)?4:0), 0);
      }
      if(ctx.kcalTarget && recipe.kcal){
        const diff = Math.abs(recipe.kcal - ctx.kcalTarget);
        score += Math.max(0, 25 - diff/20);
      }
      if(recipe.source === "Cat√°logo") score += 2;
      return score;
    }
    function findRecipes(ctx){
      const profile = App.profile || defaultProfile();
      const exclusions = profileExclusions(profile);
      const all = recipeAll();

      const filtered = all
        .filter(r => !ctx.mealKey || r.mealKey === ctx.mealKey)
        .filter(r => !ctx.style || (r.diets||[]).includes(ctx.style))
        .filter(r => recipeMatchesExclusions(r, exclusions))
        .filter(r => !ctx.maxKcal || (r.kcal || 0) <= ctx.maxKcal);

      return filtered
        .map(r => ({ r, s: scoreRecipe(r, ctx) }))
        .sort((a,b)=> b.s - a.s)
        .map(x=>x.r);
    }

    function renderRecipeDetail(recipe){
      $("#recipeDetailTag").textContent = recipe.source || "‚Äî";
      const diets = (recipe.diets||[]).map(d => `<span class="badge-soft">${esc(prettyDiet(d))}</span>`).join(" ");
      const tags = (recipe.tags||[]).slice(0,6).map(t => `<span class="badge-soft">#${esc(t)}</span>`).join(" ");

      $("#recipeDetailOut").innerHTML = `
        <div style="font-weight:900; font-size:1.05rem;">${esc(recipe.name)}</div>
        <div class="muted small mt-1">
          ${recipe.kcal ? `‚âà <b>${esc(recipe.kcal)}</b> kcal` : ""}
          ${recipe.mealKey ? ` ¬∑ ${esc(prettyMeal(recipe.mealKey))}` : ""}
        </div>
        <div class="mt-2 d-flex flex-wrap gap-2">${diets || ""}</div>
        <div class="mt-2 d-flex flex-wrap gap-2">${tags || ""}</div>
        <div class="hr"></div>
        <div style="font-weight:900">Ingredientes</div>
        ${recipe.ingredients?.length ? `<ul class="m-0 ps-3 small">${recipe.ingredients.map(x=>`<li>${esc(x)}</li>`).join("")}</ul>` : `<div class="muted small">‚Äî</div>`}
        <div class="hr"></div>
        <div style="font-weight:900">Preparaci√≥n</div>
        ${recipe.steps?.length ? `<ol class="m-0 ps-3 small">${recipe.steps.map(x=>`<li>${esc(x)}</li>`).join("")}</ol>` : `<div class="muted small">‚Äî</div>`}
      `;
    }

    function renderRecipesResultsModal(results){
      $("#recipesCount").textContent = String(results.length);
      if(!results.length){
        $("#recipesOutModal").innerHTML = `<div class="muted small">No hay recetas que cumplan filtros (prueba quitar alergias/dislikes o cambiar estilo).</div>`;
        $("#recipeDetailOut").innerHTML = `<div class="muted small">‚Äî</div>`;
        $("#recipeDetailTag").textContent = "‚Äî";
        return;
      }

      $("#recipesOutModal").innerHTML = `
        <div class="recipeGrid">
          ${results.slice(0,12).map(r=>`
            <div class="recipeCard" data-rid="${esc(String(r.id))}">
              <div class="recipeTitle">${esc(r.name)}</div>
              <div class="recipeMeta">
                ${r.kcal ? `<span class="badge-soft">${esc(r.kcal)} kcal</span>` : ""}
                <span class="badge-soft">${esc(prettyMeal(r.mealKey))}</span>
                <span class="badge-soft">${esc(prettyDiet((r.diets||[])[0] || "‚Äî"))}</span>
                <span class="badge-soft">${esc(r.source || "‚Äî")}</span>
              </div>
            </div>
          `).join("")}
        </div>
      `;

      $$("#recipesOutModal .recipeCard").forEach(card=>{
        card.addEventListener("click", ()=>{
          const id = card.getAttribute("data-rid");
          const r = results.find(x => String(x.id) === String(id));
          if(r) renderRecipeDetail(r);
        });
      });
    }

    function openRecipesModal({query="", mealKey=""} = {}){
      const plan = App.plan || Store.get(Store.keys.plan, null);
      const profile = App.profile || readProfile();
      const kcalTarget = plan ? mealKcalTarget(plan, mealKey || "comida") : 0;

      App.currentRecipeContext = { query, mealKey, kcalTarget, style: profile.style };

      $("#recipesModalTitle").textContent = mealKey
        ? `üç≥ Recetas para ${prettyMeal(mealKey)}`
        : `üç≥ Recetas Offline`;

      $("#recipeQuery").value = query || "";
      $("#recipeQueryMeal").value = mealKey || "";

      const results = findRecipes({ query, mealKey, style: profile.style, kcalTarget });
      App.currentRecipeResults = results;

      renderRecipesResultsModal(results);
      if(results[0]) renderRecipeDetail(results[0]);

      bootstrap.Modal.getOrCreateInstance($("#recipesModal")).show();
    }

    function renderRecipesPage(){
      const profile = App.profile || readProfile();
      const search = ($("#recipeSearch").value || "").trim().toLowerCase();
      const mealKey = $("#recipeMealKey").value || "";
      const diet = $("#recipeDiet").value || "";
      const maxKcal = safeNum($("#recipeMaxKcal").value, 0);

      const results = findRecipes({
        query: search,
        mealKey,
        style: diet || "",
        maxKcal: maxKcal>0 ? maxKcal : 0,
        kcalTarget: 0
      });

      $("#recipeCount").textContent = String(results.length);

      $("#recipesOut").innerHTML = results.length ? `
        <div class="recipeGrid">
          ${results.slice(0,24).map(r=>`
            <div class="recipeCard">
              <div class="recipeTitle">${esc(r.name)}</div>
              <div class="recipeMeta">
                ${r.kcal ? `<span class="badge-soft">${esc(r.kcal)} kcal</span>` : ""}
                <span class="badge-soft">${esc(prettyMeal(r.mealKey))}</span>
                <span class="badge-soft">${esc((r.diets||[]).map(prettyDiet).join(" / "))}</span>
                <span class="badge-soft">${esc(r.source || "‚Äî")}</span>
              </div>
            </div>
          `).join("")}
        </div>
        <div class="muted small mt-2">Tip: Desde Plan/Calendario abre el modal con detalle completo.</div>
      ` : `<div class="muted small">Sin resultados. Cambia filtros o agrega ‚ÄúMis recetas‚Äù.</div>`;
    }

    function openAddRecipeModal(){
      $("#newR_name").value = "";
      $("#newR_kcal").value = "";
      $("#newR_mealKey").value = "comida";
      $("#newR_ingredients").value = "";
      $("#newR_steps").value = "";
      $("#newR_tags").value = "";
      $$(".dietChk").forEach(ch => ch.checked = (ch.value === "balanceada"));
      bootstrap.Modal.getOrCreateInstance($("#addRecipeModal")).show();
    }

    function saveNewRecipe(){
      const name = ($("#newR_name").value || "").trim();
      const kcal = safeNum($("#newR_kcal").value, 0);
      const mealKey = $("#newR_mealKey").value;
      const tags = ($("#newR_tags").value || "").split(",").map(x=>x.trim().toLowerCase()).filter(Boolean);
      const ingredients = ($("#newR_ingredients").value || "").split("\n").map(x=>x.trim()).filter(Boolean);
      const steps = ($("#newR_steps").value || "").split("\n").map(x=>x.trim()).filter(Boolean);
      const diets = $$(".dietChk").filter(x=>x.checked).map(x=>x.value);

      if(!name) return toast("Pon un nombre a la receta.");
      if(!diets.length) return toast("Selecciona al menos una dieta compatible.");
      if(!ingredients.length) return toast("Agrega ingredientes.");
      if(!steps.length) return toast("Agrega pasos.");

      const rec = {
        id: crypto.randomUUID(),
        name,
        kcal: kcal>0 ? kcal : null,
        mealKey,
        diets,
        tags,
        ingredients,
        steps,
        source: "Mis recetas"
      };

      App.userRecipes.unshift(rec);
      saveUserRecipes();
      bootstrap.Modal.getOrCreateInstance($("#addRecipeModal")).hide();
      toast("Receta guardada ‚úÖ");
      renderRecipesPage();
    }

    function resetUserRecipes(){
      if(!confirm("¬øBorrar tus recetas guardadas?")) return;
      App.userRecipes = [];
      saveUserRecipes();
      toast("Mis recetas reseteadas ‚úÖ");
      renderRecipesPage();
    }

    /* ---------- Export/Import ---------- */
    function downloadJSON(obj, filename){
      const blob = new Blob([JSON.stringify(obj, null, 2)], {type:"application/json"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      a.click();
      URL.revokeObjectURL(a.href);
    }
    function exportAll(){
      const payload = {
        profile: Store.get(Store.keys.profile, null),
        plan: Store.get(Store.keys.plan, null),
        calendar: Store.get(Store.keys.calendar, []),
        userRecipes: Store.get(Store.keys.userRecipes, []),
        exported_at: new Date().toISOString()
      };
      downloadJSON(payload, "dietas_definitivo_export.json");
      toast("Exportado ‚úÖ");
    }
    function exportPlanOnly(){
      const plan = Store.get(Store.keys.plan, null);
      if(!plan) return toast("No hay plan para exportar");
      downloadJSON(plan, "plan_dietas_definitivo.json");
      toast("Plan exportado ‚úÖ");
    }
    function importAll(file){
      const r = new FileReader();
      r.onload = () => {
        try{
          const data = JSON.parse(r.result);
          if(data.profile && typeof data.profile==="object") Store.set(Store.keys.profile, data.profile);
          if(data.plan && typeof data.plan==="object") Store.set(Store.keys.plan, data.plan);
          if(Array.isArray(data.calendar)) Store.set(Store.keys.calendar, data.calendar);
          if(Array.isArray(data.userRecipes)) Store.set(Store.keys.userRecipes, data.userRecipes);

          App.profile = Store.get(Store.keys.profile, defaultProfile());
          writeProfile(App.profile);
          updateKPIs();

          loadRecipes();

          App.plan = Store.get(Store.keys.plan, null);
          renderPlan(App.plan);

          loadCalendarFromStorage();
          renderItinerary();
          renderRecipesPage();
          toast("Importado ‚úÖ");
        }catch(e){
          alert("JSON inv√°lido: " + e.message);
        }
      };
      r.readAsText(file);
    }
    function hardReset(){
      if(!confirm("¬øReset TOTAL? (perfil + plan + calendario + mis recetas)")) return;
      Store.del(Store.keys.profile);
      Store.del(Store.keys.plan);
      Store.del(Store.keys.calendar);
      Store.del(Store.keys.userRecipes);
      location.reload();
    }

    /* ---------- Plan flow ---------- */
    function generatePlanFlow(){
      App.profile = readProfile();
      Store.set(Store.keys.profile, App.profile);
      $("#pillUser").textContent = App.profile.name || "Usuario";

      const calc = updateKPIs();
      const week = generateWeekPlan(App.profile);

      App.plan = {
        profile: App.profile,
        calc,
        macros: calc.macros,
        week,
        created_at: new Date().toISOString()
      };
      Store.set(Store.keys.plan, App.plan);

      renderPlan(App.plan);
      loadCalendarFromPlan(App.plan);
      renderItinerary();
      toast("Plan generado ‚úÖ");
    }

    /* ---------- Event modal ---------- */
    function openEventModal(mode){
      if(!App.selectedEvent) return toast("Selecciona un evento.");
      const modal = bootstrap.Modal.getOrCreateInstance($("#eventModal"));

      const curDate = ymdLocal(App.selectedEvent.start);
      const curTime = String(App.selectedEvent.startStr).slice(11,16);

      $("#modalTitleInput").value = App.selectedEvent.title || "";
      $("#modalDateInput").value = curDate;
      $("#modalTimeInput").value = curTime;

      if(mode === "edit"){
        $("#eventModalTitle").textContent = "Editar evento";
        $("#modalTitleRow").style.display = "";
        $("#modalDateTimeRow").style.display = "none";
      } else {
        $("#eventModalTitle").textContent = "Mover evento";
        $("#modalTitleRow").style.display = "none";
        $("#modalDateTimeRow").style.display = "";
      }

      $("#modalSaveBtn").onclick = ()=>{
        if(!App.selectedEvent) return;

        if(mode === "edit"){
          const t = ($("#modalTitleInput").value || "").trim();
          if(t) App.selectedEvent.setProp("title", t);
        } else {
          const date = $("#modalDateInput").value;
          const time = $("#modalTimeInput").value;
          if(!date || !time) return;

          const newStart = `${date}T${time}:00`;
          const dur = (MEAL_DURATION_MIN[App.selectedEvent.extendedProps?.mealKey] || 45);
          const newEnd = addMinutesToISO(newStart, dur);

          App.selectedEvent.setStart(newStart);
          App.selectedEvent.setEnd(newEnd);
        }

        persistCalendar();
        setDetailFromEvent(App.selectedEvent);
        modal.hide();
        toast("Guardado ‚úÖ");
      };

      modal.show();
    }

    function deleteSelectedEvent(){
      if(!App.selectedEvent) return toast("Selecciona un evento.");
      if(!confirm("¬øBorrar este evento?")) return;
      App.selectedEvent.remove();
      App.selectedEvent = null;
      persistCalendar();
      ["detailDate","detailType","detailTime","detailMeal","detailPortion","sheetDate","sheetType","sheetTime","sheetMeal","sheetPortion"]
        .forEach(id => $("#"+id).textContent = "‚Äî");
      toast("Borrado ‚úÖ");
    }

    /* ---------- Init ---------- */
    document.addEventListener("DOMContentLoaded", async ()=>{
      // nav
      $$(".navbtn").forEach(btn => btn.addEventListener("click", ()=> App.showView(btn.dataset.view)));

      // profile
      App.profile = Store.get(Store.keys.profile, defaultProfile());
      writeProfile(App.profile);
      updateKPIs();

      ["name","sex","age","height","weight","activity","goal","style","allergies","dislikes"].forEach(id=>{
        $("#"+id).addEventListener("input", ()=>{
          updateKPIs();
          $("#pillUser").textContent = ($("#name").value || "Usuario").trim();
        });
        $("#"+id).addEventListener("change", ()=>{
          updateKPIs();
          $("#pillUser").textContent = ($("#name").value || "Usuario").trim();
        });
      });

      $("#btnSaveProfile").addEventListener("click", ()=>{
        App.profile = readProfile();
        Store.set(Store.keys.profile, App.profile);
        updateKPIs();
        toast("Perfil guardado ‚úÖ");
      });

      $("#btnResetProfile").addEventListener("click", ()=>{
        App.profile = defaultProfile();
        Store.set(Store.keys.profile, App.profile);
        writeProfile(App.profile);
        updateKPIs();
        toast("Perfil reseteado ‚úÖ");
      });

      // plan
      $("#btnGeneratePlan").addEventListener("click", generatePlanFlow);
      $("#btnQuickPlan").addEventListener("click", ()=>{
        App.showView("viewPlan");
        $("#btnGeneratePlan").click();
      });

      $("#btnClearPlan").addEventListener("click", ()=>{
        if(!confirm("¬øLimpiar plan y calendario?")) return;
        Store.del(Store.keys.plan);
        Store.del(Store.keys.calendar);
        App.plan = null;
        renderPlan(null);
        if(App.fullcalendarOk && App.calendar) App.calendar.removeAllEvents();
        renderMiniCalendar();
        renderItinerary();
        toast("Plan limpiado üßπ");
      });

      // export/import/reset
      $("#btnExport").addEventListener("click", exportAll);
      $("#btnExportPlan").addEventListener("click", exportPlanOnly);
      $("#fileImport").addEventListener("change", function(){
        const f = this.files && this.files[0];
        if(f) importAll(f);
        this.value = "";
      });
      $("#btnHardReset").addEventListener("click", hardReset);

      // calendar buttons
      $("#btnToday").addEventListener("click", ()=>{ if(App.fullcalendarOk && App.calendar) App.calendar.today(); toast("Hoy ‚úÖ"); });
      $("#btnReloadFromPlan").addEventListener("click", ()=>{
        if(!App.plan) return toast("No hay plan. Genera uno primero.");
        loadCalendarFromPlan(App.plan);
        renderItinerary();
        toast("Recargado ‚úÖ");
      });

      // detail buttons
      $("#btnEditEvent").addEventListener("click", ()=> openEventModal("edit"));
      $("#btnMoveEvent").addEventListener("click", ()=> openEventModal("move"));
      $("#btnDeleteEvent").addEventListener("click", deleteSelectedEvent);

      $("#btnEditEventM").addEventListener("click", ()=> openEventModal("edit"));
      $("#btnMoveEventM").addEventListener("click", ()=> openEventModal("move"));
      $("#btnDeleteEventM").addEventListener("click", deleteSelectedEvent);

      // detail recipes
      $("#btnDetailRecipes").addEventListener("click", ()=>{
        if(!App.selectedEvent) return toast("Selecciona un evento.");
        openRecipesModal({ query: App.selectedEvent.title || "", mealKey: App.selectedEvent.extendedProps?.mealKey || "" });
      });
      $("#btnDetailRecipesM").addEventListener("click", ()=>{
        if(!App.selectedEvent) return toast("Selecciona un evento.");
        openRecipesModal({ query: App.selectedEvent.title || "", mealKey: App.selectedEvent.extendedProps?.mealKey || "" });
      });

      // print itinerary
      $("#btnPrint").addEventListener("click", ()=> window.print());

      // recipes page actions
      $("#btnApplyRecipeFilter").addEventListener("click", renderRecipesPage);
      $("#btnAddRecipe").addEventListener("click", openAddRecipeModal);
      $("#btnSaveNewRecipe").addEventListener("click", saveNewRecipe);
      $("#btnResetRecipes").addEventListener("click", resetUserRecipes);
      $("#btnOpenRecipesFromPlan").addEventListener("click", ()=> openRecipesModal({query:"", mealKey:""}));

      // recipes modal search
      $("#btnSearchRecipes").addEventListener("click", ()=>{
        const query = ($("#recipeQuery").value || "").trim();
        const mk = $("#recipeQueryMeal").value || "";
        const profile = App.profile || readProfile();
        const plan = App.plan || Store.get(Store.keys.plan, null);
        const kcalTarget = plan ? mealKcalTarget(plan, mk || "comida") : 0;

        const results = findRecipes({ query, mealKey: mk, style: profile.style, kcalTarget });
        App.currentRecipeResults = results;
        renderRecipesResultsModal(results);
        if(results[0]) renderRecipeDetail(results[0]);
      });

      // load libs
      const [fcOk, chartOk] = await Promise.all([loadFullCalendarGlobal(), loadChart()]);
      App.fullcalendarOk = !!fcOk;
      App.chartOk = !!chartOk;

      // init calendar
      initCalendarIfAvailable();

      // load recipes
      loadRecipes();

      // load plan
      App.plan = Store.get(Store.keys.plan, null);
      renderPlan(App.plan);

      // load calendar
      const existing = Store.get(Store.keys.calendar, []);
      if(App.plan && (!existing || !existing.length)){
        loadCalendarFromPlan(App.plan);
      } else {
        loadCalendarFromStorage();
      }

      renderItinerary();
      renderRecipesPage();
      toast("Listo ‚úÖ");
    });
  </script>
</body>
</html>
