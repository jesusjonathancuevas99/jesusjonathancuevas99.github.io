<!DOCTYPE html>
<html lang="es" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>LinguaTutor ULTIMATE ‚Äî Chat PRO + Pronunciaci√≥n + Python</title>
  <meta name="theme-color" content="#0b1220" />

  <!-- UI / Libraries (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>

  <!-- Optional helpers -->
  <script src="https://cdn.jsdelivr.net/npm/localforage@1.10.0/dist/localforage.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fuse.js@7.0.0"></script>

  <!-- Pyodide (Python in the browser) -->
  <script src="https://cdn.jsdelivr.net/pyodide/v0.25.1/full/pyodide.js"></script>

  <!-- Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />

  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: { sans: ['Inter','system-ui','-apple-system','Segoe UI','Roboto','sans-serif'] },
          colors: {
            brand: {
              50:'#eef6ff',100:'#d9ecff',200:'#b8dcff',300:'#86c6ff',400:'#4aa7ff',
              500:'#1d86ff',600:'#0d6ae6',700:'#0f54b8',800:'#12458f',900:'#123b76'
            },
            ink: { 950:'#070b12', 900:'#0b1220', 850:'#0f172a', 800:'#111c33', 700:'#1a2a4d' },
          }
        }
      }
    }
  </script>

  <style>
    :root{
      /* will be updated by ResizeObserver to avoid mobile content being hidden by the input bar */
      --inputH: 140px;
    }
    html, body { height: 100%; }
    body { background:#070b12; color:#e5e7eb; overflow:hidden; }

    /* Better mobile viewport behavior */
    #app { height: 100svh; height: 100dvh; display:flex; flex-direction:column; }

    /* Scrollbar */
    .no-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
    .no-scrollbar::-webkit-scrollbar-thumb { background:#24324f; border-radius: 999px; }

    /* Markdown */
    .prose table { width:100%; margin: 12px 0; border-collapse: collapse; font-size: .92em; }
    .prose th { text-align:left; padding:10px; border-bottom:2px solid #223253; color:#93a4c2; text-transform:uppercase; font-size:.75em; letter-spacing:.06em; }
    .prose td { padding:10px; border-bottom:1px solid #1a2a4d; }
    .prose strong { color:#7dd3fc; font-weight: 650; }
    .prose code { background:#0f172a; padding:2px 6px; border-radius:8px; color:#f0abfc; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .prose a { color:#60a5fa; text-decoration: underline; }
    .prose blockquote { border-left: 3px solid #1d86ff; padding-left: 12px; color:#cbd5e1; }

    /* Chat bubbles */
    .bubble { padding: 12px 14px; border-radius: 18px; max-width: 100%; word-wrap: break-word; font-size: 15px; position: relative; }
    .bubble-user { background: linear-gradient(135deg, #0d6ae6, #1d86ff); color: #fff; border-radius: 18px 18px 6px 18px; margin-left:auto; max-width: 88%; box-shadow: 0 10px 30px rgba(29,134,255,.18); }
    .bubble-ai { background: rgba(15, 23, 42, .82); border: 1px solid rgba(34,50,83,.8); border-radius: 18px 18px 18px 6px; width: 100%; box-shadow: 0 12px 40px rgba(0,0,0,.22); }

    /* Cards */
    .card { background: rgba(11,18,32,.84); border:1px solid rgba(34,50,83,.7); border-radius: 18px; }
    .chip { background:#0f172a; border:1px solid rgba(34,50,83,.9); }

    /* Input */
    .input-area { background: rgba(11,18,32,.92); border-top: 1px solid rgba(34,50,83,.6); padding-bottom: max(14px, env(safe-area-inset-bottom)); }

    /* Subtle glow */
    .glow { box-shadow: 0 0 0 1px rgba(29,134,255,.25), 0 15px 60px rgba(29,134,255,.12); }

    /* Skeleton */
    .shimmer { background: linear-gradient(90deg, rgba(255,255,255,.05), rgba(255,255,255,.10), rgba(255,255,255,.05)); background-size: 200% 100%; animation: shimmer 1.2s infinite; }
    @keyframes shimmer { 0%{background-position:0% 0%} 100%{background-position:-200% 0%} }

    /* Ensure scroll area leaves room for input bar on mobile */
    .chat-pad { padding-bottom: calc(var(--inputH) + 18px); }

    /* Audio control look */
    audio { width: 100%; }

    #chatScroll{ min-height:0; -webkit-overflow-scrolling: touch; overscroll-behavior: contain; }
    #app main, #app section { min-height:0; }
  </style>
</head>

<body>
<div id="app">
  <!-- HEADER -->
  <header class="h-14 flex items-center justify-between px-4 bg-ink-900/80 backdrop-blur border-b border-ink-700/60 z-50">
    <div class="flex items-center gap-3 min-w-0">
      <div class="w-9 h-9 rounded-xl bg-gradient-to-br from-brand-500 to-indigo-600 flex items-center justify-center text-white shadow-lg">
        <i class="fa-solid fa-graduation-cap"></i>
      </div>
      <div class="min-w-0">
        <h1 class="font-bold text-sm tracking-wide text-gray-100 truncate">LinguaTutor ULTIMATE</h1>
        <div class="flex items-center gap-2">
          <span class="w-1.5 h-1.5 rounded-full" :class="internetOk ? 'bg-emerald-400' : 'bg-yellow-400'"></span>
          <span class="text-[10px] text-gray-400 font-medium uppercase">{{ internetOk ? 'Internet OK' : 'Fallback local' }}</span>
          <span class="text-[10px] text-gray-600">‚Ä¢</span>
          <span class="text-[10px] text-gray-500 font-medium uppercase">{{ modeLabel }}</span>
          <span class="text-[10px] text-gray-600">‚Ä¢</span>
          <span class="text-[10px]" :class="pyReady ? 'text-emerald-300' : 'text-gray-500'">
            <i class="fa-brands fa-python mr-1"></i>{{ pyReady ? 'Python listo' : 'Python off' }}
          </span>
        </div>
      </div>
    </div>

    <div class="flex items-center gap-2">
      <button @click="mode = (mode==='chat' ? 'pron' : 'chat')" class="w-9 h-9 rounded-full bg-ink-850 border border-ink-700/70 flex items-center justify-center text-gray-300 hover:text-white transition" :title="mode==='chat' ? 'Ir a Pronunciaci√≥n' : 'Volver al Chat'">
        <i class="fa-solid" :class="mode==='chat' ? 'fa-microphone' : 'fa-comments'"></i>
      </button>
      <button @click="toggleSide" class="w-9 h-9 rounded-full bg-ink-850 border border-ink-700/70 flex items-center justify-center text-gray-400 hover:text-white transition" title="Panel">
        <i class="fa-solid fa-sliders"></i>
      </button>
      <button @click="showConfig=true" class="w-9 h-9 rounded-full bg-ink-850 border border-ink-700/70 flex items-center justify-center text-gray-400 hover:text-white transition" title="Configuraci√≥n">
        <i class="fa-solid fa-gear"></i>
      </button>
    </div>
  </header>

  <!-- MAIN -->
  <main class="flex-1 overflow-hidden min-h-0">
    <div class="h-full min-h-0 grid grid-cols-1 lg:grid-cols-[1fr_360px]">

      <!-- PRIMARY COLUMN -->
      <section class="h-full min-h-0 flex flex-col overflow-hidden">

        <!-- ========================= CHAT VIEW ========================= -->
        <div v-show="mode==='chat'" class="h-full min-h-0 flex flex-col overflow-hidden">
          <!-- chat scroll container -->
          <div id="chatScroll" class="flex-1 min-h-0 overflow-y-auto no-scrollbar scroll-smooth p-4 space-y-5 chat-pad">

            <!-- Welcome -->
            <div v-if="messages.length===0" class="min-h-[calc(100dvh-56px-160px)] flex flex-col items-center justify-center -mt-2">
              <div class="text-center space-y-2 mb-8 px-6">
                <div class="mx-auto w-14 h-14 rounded-2xl bg-ink-850 border border-ink-700/70 flex items-center justify-center">
                  <i class="fa-solid fa-wand-magic-sparkles text-2xl text-brand-400"></i>
                </div>
                <h2 class="text-lg font-extrabold text-white mt-3">¬øQu√© aprendemos hoy, {{ displayName || 'amigo' }}?</h2>
                <p class="text-sm text-gray-400">Chat con herramientas, fuentes reales, memoria anti-repetici√≥n, notebook, vocab y modo Python opcional.</p>
                <p class="text-[11px] text-gray-500">Tip: comandos <span class="font-mono">/define</span>, <span class="font-mono">/wiki</span>, <span class="font-mono">/quiz</span>, <span class="font-mono">/grammar</span>, <span class="font-mono">/export</span>, <span class="font-mono">/python</span>.</p>
              </div>

              <div class="w-full max-w-md grid grid-cols-2 gap-3 px-4">
                <button @click="sendText('/quiz work')" class="p-4 card hover:bg-ink-850/70 transition text-left group">
                  <div class="text-brand-300 text-xl mb-2 group-hover:scale-110 transition"><i class="fa-solid fa-list-check"></i></div>
                  <div class="font-bold text-sm text-gray-200">Quiz r√°pido</div>
                  <div class="text-[10px] text-gray-500">Vocab + uso</div>
                </button>
                <button @click="sendText('/grammar past simple')" class="p-4 card hover:bg-ink-850/70 transition text-left group">
                  <div class="text-purple-300 text-xl mb-2 group-hover:scale-110 transition"><i class="fa-solid fa-book-open"></i></div>
                  <div class="font-bold text-sm text-gray-200">Gram√°tica PRO</div>
                  <div class="text-[10px] text-gray-500">Explica + ejercicios</div>
                </button>
                <button @click="sendText('/wiki Coffee')" class="col-span-2 p-4 bg-emerald-600/10 hover:bg-emerald-600/20 border border-emerald-500/20 rounded-xl flex items-center justify-between group transition">
                  <div>
                    <div class="font-bold text-sm text-emerald-300">Lectura real (Wikipedia)</div>
                    <div class="text-[10px] text-emerald-200/60">con preguntas y vocab</div>
                  </div>
                  <div class="w-8 h-8 rounded-full bg-emerald-500 flex items-center justify-center text-white"><i class="fa-solid fa-book"></i></div>
                </button>
                <button @click="sendText('Quiero frases √∫tiles para mi trabajo en almac√©n, con audio y un ejercicio.')" class="col-span-2 p-4 bg-brand-600/10 hover:bg-brand-600/20 border border-brand-500/20 rounded-xl flex items-center justify-between group transition">
                  <div>
                    <div class="font-bold text-sm text-brand-300">Frases √∫tiles + pr√°ctica</div>
                    <div class="text-[10px] text-brand-200/60">anti-repetici√≥n</div>
                  </div>
                  <div class="w-8 h-8 rounded-full bg-brand-500 flex items-center justify-center text-white"><i class="fa-solid fa-play"></i></div>
                </button>
              </div>
            </div>

            <!-- Messages -->
            <div v-for="msg in messages" :key="msg.id" class="">
              <div v-if="msg.role==='user'" class="flex justify-end">
                <div class="bubble bubble-user">{{ msg.text }}</div>
              </div>

              <div v-else class="flex gap-3 max-w-3xl mx-auto">
                <div class="w-9 h-9 rounded-full bg-ink-850 border border-ink-700/70 flex items-center justify-center shrink-0 mt-1">
                  <i class="fa-solid fa-robot text-brand-300 text-xs"></i>
                </div>
                <div class="flex-1 min-w-0">
                  <div class="bubble bubble-ai">
                    <div class="prose prose-invert prose-sm max-w-none" v-html="renderMD(msg.text)"></div>
                    <div v-if="msg.sources && msg.sources.length" class="mt-3 border-t border-ink-700/50 pt-3">
                      <div class="flex items-center justify-between">
                        <div class="text-[11px] uppercase tracking-wider text-gray-400 font-bold">Fuentes</div>
                        <button @click="msg.showSources=!msg.showSources" class="text-[11px] text-gray-400 hover:text-white">
                          {{ msg.showSources ? 'Ocultar' : 'Ver' }}
                        </button>
                      </div>
                      <div v-show="msg.showSources" class="mt-2 space-y-2">
                        <a v-for="(s,i) in msg.sources" :key="i" :href="s.url" target="_blank" rel="noreferrer" class="block p-2 rounded-xl bg-ink-900/60 border border-ink-700/50 hover:bg-ink-850/70">
                          <div class="text-xs text-gray-200 font-semibold truncate">{{ s.title || s.url }}</div>
                          <div class="text-[11px] text-gray-400 line-clamp-2">{{ s.snippet }}</div>
                        </a>
                      </div>
                    </div>
                  </div>

                  <div class="flex flex-wrap gap-2 mt-2 ml-1">
                    <button @click="tts(msg.text)" class="text-[11px] chip px-3 py-1.5 rounded-full text-gray-300 hover:text-white flex items-center gap-2 transition">
                      <i class="fa-solid fa-volume-high text-brand-200"></i> Escuchar
                    </button>
                    <button @click="copy(msg.text)" class="text-[11px] chip px-3 py-1.5 rounded-full text-gray-300 hover:text-white flex items-center gap-2 transition">
                      <i class="fa-regular fa-copy"></i> Copiar
                    </button>
                    <button @click="regenerate(msg)" class="text-[11px] chip px-3 py-1.5 rounded-full text-gray-300 hover:text-white flex items-center gap-2 transition">
                      <i class="fa-solid fa-rotate-right"></i> Variar
                    </button>
                    <button v-if="msg.sources && msg.sources.length" @click="pinToNotebook(msg)" class="text-[11px] chip px-3 py-1.5 rounded-full text-gray-300 hover:text-white flex items-center gap-2 transition">
                      <i class="fa-solid fa-thumbtack"></i> Guardar
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Loader -->
            <div v-if="loading" class="max-w-3xl mx-auto">
              <div class="flex items-center gap-3">
                <div class="w-9 h-9 rounded-full bg-ink-850 border border-ink-700/70"></div>
                <div class="flex-1">
                  <div class="h-4 w-40 rounded-full shimmer"></div>
                  <div class="mt-2 h-3 w-72 rounded-full shimmer opacity-80"></div>
                  <div class="mt-2 h-3 w-64 rounded-full shimmer opacity-60"></div>
                </div>
              </div>
            </div>

          </div>

          <!-- INPUT (sticky inside chat column) -->
          <div id="inputBar" class="input-area px-3 pt-3">
            <div class="max-w-3xl mx-auto">
              <div class="flex gap-2 mb-2 overflow-x-auto pb-1 no-scrollbar">
                <button @click="sendText('/define safety')" class="flex-shrink-0 px-3 py-1.5 chip rounded-full text-xs text-emerald-200 whitespace-nowrap hover:bg-ink-850">üìò /define</button>
                <button @click="sendText('/wiki Mexico')" class="flex-shrink-0 px-3 py-1.5 chip rounded-full text-xs text-purple-200 whitespace-nowrap hover:bg-ink-850">üìñ /wiki</button>
                <button @click="sendText('/quiz work')" class="flex-shrink-0 px-3 py-1.5 chip rounded-full text-xs text-brand-200 whitespace-nowrap hover:bg-ink-850">üìù /quiz</button>
                <button @click="sendText('/grammar past simple')" class="flex-shrink-0 px-3 py-1.5 chip rounded-full text-xs text-yellow-200 whitespace-nowrap hover:bg-ink-850">üìö /grammar</button>
                <button @click="sendText('/python')" class="flex-shrink-0 px-3 py-1.5 chip rounded-full text-xs text-sky-200 whitespace-nowrap hover:bg-ink-850">üêç /python</button>
                <button @click="sendText('/export')" class="flex-shrink-0 px-3 py-1.5 chip rounded-full text-xs text-gray-200 whitespace-nowrap hover:bg-ink-850">‚¨áÔ∏è /export</button>
                <button @click="toggleVoiceInput" class="flex-shrink-0 px-3 py-1.5 rounded-full text-xs whitespace-nowrap border" :class="isVoiceInput ? 'bg-red-600/15 border-red-500/20 text-red-200' : 'chip text-gray-200'">
                  üé§ Dictado: {{ isVoiceInput ? 'ON' : 'OFF' }}
                </button>
              </div>

              <div class="flex items-end gap-2 bg-ink-850/70 border border-ink-700/60 rounded-3xl p-1.5 pl-4 glow">
                <textarea v-model="input" @keydown.enter.exact.prevent="send" @keydown.enter.shift.stop
                  ref="textarea" rows="1"
                  class="bg-transparent text-gray-100 w-full py-2.5 outline-none resize-none max-h-36 placeholder-gray-500 text-[15px]"
                  placeholder="Escribe o usa comandos: /wiki Coffee, /define forklift, /quiz work... (Shift+Enter = salto)"
                ></textarea>
                <button @click="send" :disabled="!input.trim()" class="w-10 h-10 rounded-full bg-brand-600 hover:bg-brand-500 text-white flex items-center justify-center shrink-0 mb-0.5 shadow-lg active:scale-95 transition disabled:opacity-50">
                  <i class="fa-solid fa-paper-plane text-xs"></i>
                </button>
              </div>

              <div class="flex items-center justify-between mt-2 px-1">
                <div class="text-[10px] text-gray-500">Motor: Wikipedia + DictionaryAPI + Datamuse + (OpenLibrary/Crossref opcional) + Memoria local.</div>
                <div class="text-[10px] text-gray-500">{{ statusLine }}</div>
              </div>
            </div>
          </div>
        </div>

        <!-- ===================== PRONUNCIATION VIEW ===================== -->
        <div v-show="mode==='pron'" class="flex-1 min-h-0 overflow-y-auto no-scrollbar p-4">
          <div class="max-w-3xl mx-auto space-y-4">

            <div class="card p-4">
              <div class="flex items-start justify-between gap-3">
                <div>
                  <h2 class="text-base font-extrabold text-white flex items-center gap-2">
                    <i class="fa-solid fa-microphone text-emerald-300"></i>
                    Pronunciaci√≥n & Calificaci√≥n
                  </h2>
                  <p class="text-sm text-gray-400 mt-1">Genera frases, presiona <b>Grabar</b>, pronuncia y recibe calificaci√≥n basada en SpeechRecognition (speech-to-text).</p>
                  <p class="text-[11px] text-gray-500 mt-2 leading-relaxed">Nota: algunos navegadores procesan el reconocimiento en servicios del proveedor y puede requerir internet.</p>
                </div>
                <div class="text-right">
                  <div class="text-[10px] uppercase text-gray-500">Promedio</div>
                  <div class="text-2xl font-black" :class="overallScoreColor">{{ overallScore }}%</div>
                  <div class="text-[10px] text-gray-500">({{ doneCount }}/{{ practiceList.length }} completadas)</div>
                </div>
              </div>

              <div class="mt-4 grid grid-cols-1 sm:grid-cols-3 gap-2">
                <div class="sm:col-span-2">
                  <label class="text-[11px] uppercase text-gray-500 font-bold">Tema (opcional)</label>
                  <input v-model="practiceTopic" type="text" class="mt-1 w-full bg-ink-950/50 border border-ink-700/70 rounded-xl p-3 text-sm text-gray-200 outline-none focus:border-emerald-500" placeholder="Ej: work, travel, safety, food..." />
                </div>
                <div class="flex items-end gap-2">
                  <button @click="generatePracticeSet" class="w-full bg-emerald-600 hover:bg-emerald-500 text-white py-3 rounded-xl font-extrabold text-sm flex items-center justify-center gap-2">
                    <i class="fa-solid fa-wand-magic-sparkles"></i> Generar
                  </button>
                </div>
              </div>

              <div class="mt-3 flex flex-wrap gap-2">
                <button @click="practiceTopic='work'; generatePracticeSet()" class="px-3 py-1.5 chip rounded-full text-xs text-emerald-200 hover:bg-ink-850">üè≠ Work</button>
                <button @click="practiceTopic='travel'; generatePracticeSet()" class="px-3 py-1.5 chip rounded-full text-xs text-emerald-200 hover:bg-ink-850">üß≥ Travel</button>
                <button @click="practiceTopic='food'; generatePracticeSet()" class="px-3 py-1.5 chip rounded-full text-xs text-emerald-200 hover:bg-ink-850">üçΩÔ∏è Food</button>
                <button @click="practiceTopic='safety'; generatePracticeSet()" class="px-3 py-1.5 chip rounded-full text-xs text-emerald-200 hover:bg-ink-850">ü¶∫ Safety</button>
              </div>

              <div v-if="!speechSupported" class="mt-4 text-sm text-yellow-300 bg-yellow-600/10 border border-yellow-500/20 p-3 rounded-xl">
                ‚ö†Ô∏è Tu navegador no soporta SpeechRecognition para calificar pronunciaci√≥n. Aun as√≠ podr√°s grabar y escucharte.
              </div>
              <div v-else class="mt-4 text-sm text-gray-400 bg-ink-950/40 border border-ink-700/50 p-3 rounded-xl">
                ‚úÖ SpeechRecognition disponible. Se usar√° para transcribir tu voz y evaluar parecido con la frase objetivo.
              </div>
            </div>

            <!-- Current phrase card -->
            <div v-if="practiceList.length" class="card p-4">
              <div class="flex items-start justify-between gap-3">
                <div class="min-w-0">
                  <div class="text-[10px] uppercase text-gray-500 font-bold">Frase actual</div>
                  <div class="text-lg font-extrabold text-white mt-1 break-words">‚Äú{{ currentItem.text }}‚Äù</div>
                  <div class="mt-2 flex flex-wrap items-center gap-2">
                    <button @click="ttsPractice(currentItem.text)" class="px-3 py-1.5 chip rounded-full text-xs text-gray-200 hover:bg-ink-850 flex items-center gap-2">
                      <i class="fa-solid fa-volume-high text-emerald-300"></i> Escuchar (TTS)
                    </button>
                    <button @click="prevPractice" :disabled="currentIndex===0" class="px-3 py-1.5 chip rounded-full text-xs text-gray-200 hover:bg-ink-850 disabled:opacity-40">‚óÄ Anterior</button>
                    <button @click="nextPractice" :disabled="currentIndex===practiceList.length-1" class="px-3 py-1.5 chip rounded-full text-xs text-gray-200 hover:bg-ink-850 disabled:opacity-40">Siguiente ‚ñ∂</button>
                  </div>
                </div>
                <div class="text-right">
                  <div class="text-[10px] uppercase text-gray-500 font-bold">Tu score</div>
                  <div class="text-2xl font-black" :class="scoreColor(currentItem.score)">{{ currentItem.score ?? '--' }}<span v-if="currentItem.score!==null">%</span></div>
                  <div class="text-[10px] text-gray-500" v-if="currentItem.score!==null">{{ currentItem.passed ? '‚úÖ Bien' : '‚ùå Falta' }}</div>
                </div>
              </div>

              <div class="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-3">
                <!-- Recorder -->
                <div class="bg-ink-950/40 border border-ink-700/50 rounded-xl p-3">
                  <div class="flex items-center justify-between">
                    <div class="text-[11px] uppercase text-gray-500 font-bold">Grabaci√≥n</div>
                    <div class="text-[11px] text-gray-500">{{ recStateLabel }}</div>
                  </div>
                  <div class="mt-3 flex gap-2">
                    <button @click="toggleRecord" :disabled="recBusy" class="flex-1 py-3 rounded-xl font-extrabold text-sm flex items-center justify-center gap-2 transition" :class="isRecording ? 'bg-red-600 hover:bg-red-500 text-white' : 'bg-emerald-600 hover:bg-emerald-500 text-white'">
                      <i class="fa-solid" :class="isRecording ? 'fa-stop' : 'fa-microphone'"></i>
                      {{ isRecording ? 'Detener' : 'Grabar' }}
                    </button>
                    <button @click="clearRecording" :disabled="!lastAudioUrl && !lastTranscript" class="px-4 py-3 rounded-xl font-bold text-sm chip text-gray-200 hover:bg-ink-850 disabled:opacity-40">Limpiar</button>
                  </div>
                  <div class="mt-3" v-if="lastAudioUrl">
                    <audio :src="lastAudioUrl" controls></audio>
                    <div class="text-[10px] text-gray-500 mt-1">Audio grabado con MediaRecorder.</div>
                  </div>
                </div>

                <!-- Recognition -->
                <div class="bg-ink-950/40 border border-ink-700/50 rounded-xl p-3">
                  <div class="text-[11px] uppercase text-gray-500 font-bold">Reconocimiento (lo que entendi√≥)</div>
                  <div v-if="speechSupported" class="mt-2">
                    <div class="text-sm text-gray-200 bg-ink-900/60 border border-ink-700/50 rounded-xl p-3 min-h-[64px]">{{ lastTranscript || '‚Äî' }}</div>
                    <div class="mt-2 text-[11px] text-gray-500">Se compara tu transcripci√≥n vs la frase objetivo para dar %.</div>
                  </div>
                  <div v-else class="mt-2 text-sm text-yellow-300">SpeechRecognition no disponible.</div>

                  <div class="mt-3" v-if="currentItem.score!==null">
                    <div class="flex items-center justify-between text-[11px] text-gray-400">
                      <span>Precisi√≥n</span>
                      <span class="font-bold text-gray-200">{{ currentItem.score }}%</span>
                    </div>
                    <div class="mt-1 h-2 bg-ink-850 rounded-full overflow-hidden">
                      <div class="h-2 rounded-full" :class="currentItem.passed ? 'bg-emerald-500' : 'bg-red-500'" :style="{ width: currentItem.score + '%' }"></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- List -->
            <div v-if="practiceList.length" class="card p-4">
              <div class="flex items-center justify-between mb-2">
                <div class="text-[11px] uppercase text-gray-500 font-bold">Lista de pr√°ctica</div>
                <div class="flex items-center gap-2">
                  <label class="text-[11px] text-gray-400">Umbral ‚ÄúBien‚Äù</label>
                  <input v-model.number="passThreshold" type="number" min="50" max="95" class="w-20 bg-ink-950/50 border border-ink-700/70 rounded-xl p-2 text-sm text-gray-200 outline-none focus:border-brand-500 text-right" />
                  <button @click="resetPracticeScores" class="text-[11px] text-gray-300 hover:text-white chip px-3 py-2 rounded-xl">Reiniciar</button>
                </div>
              </div>
              <div class="space-y-2">
                <div v-for="(it, idx) in practiceList" :key="it.id" @click="currentIndex = idx; clearRecording()" class="p-3 rounded-xl border flex items-start justify-between gap-3 cursor-pointer transition" :class="rowClass(it, idx)">
                  <div class="min-w-0">
                    <div class="text-[10px] uppercase text-gray-500 font-bold">#{{ idx+1 }}</div>
                    <div class="text-sm font-semibold break-words">{{ it.text }}</div>
                    <div class="text-[11px] text-gray-500 mt-1" v-if="it.transcript"><span class="text-gray-400">Dijiste:</span> ‚Äú{{ it.transcript }}‚Äù</div>
                  </div>
                  <div class="text-right shrink-0">
                    <div class="text-[10px] uppercase text-gray-500 font-bold">Score</div>
                    <div class="text-lg font-black" :class="scoreColor(it.score)">{{ it.score===null ? '--' : it.score + '%' }}</div>
                  </div>
                </div>
              </div>
              <div class="mt-3 text-[11px] text-gray-500">‚úÖ Verde = bien (‚â• {{ passThreshold }}%). ‚ùå Rojo = mejorar.</div>
            </div>

            <div class="h-20"></div>
          </div>
        </div>

      </section>

      <!-- SIDE PANEL (Desktop): only for chat (but stays available) -->
      <div id="panelOverlay" v-show="sideOpen" @click="toggleSide" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[55] lg:hidden"></div>

      <aside class="fixed lg:static inset-y-0 right-0 w-[92vw] max-w-[380px] lg:w-auto lg:max-w-none border-l border-ink-700/60 bg-ink-900/90 lg:bg-ink-900/60 backdrop-blur overflow-y-auto no-scrollbar transform transition-transform duration-200 z-[60]" :class="sideOpen ? 'translate-x-0' : 'translate-x-full lg:translate-x-0'">
        <div class="p-4 space-y-4">
          <div class="card p-4">
            <div class="flex items-center justify-between">
              <div class="font-bold text-white">Panel</div>
              <div class="text-[11px] text-gray-400">Ultimate</div>
            </div>
            <div class="mt-3 grid grid-cols-2 gap-2">
              <button @click="sideTab='tools'" class="px-3 py-2 rounded-xl border text-xs" :class="sideTab==='tools' ? 'bg-brand-600/15 border-brand-500/25 text-brand-200' : 'chip text-gray-200'">Herramientas</button>
              <button @click="sideTab='notebook'" class="px-3 py-2 rounded-xl border text-xs" :class="sideTab==='notebook' ? 'bg-brand-600/15 border-brand-500/25 text-brand-200' : 'chip text-gray-200'">Notebook</button>
              <button @click="sideTab='vocab'" class="px-3 py-2 rounded-xl border text-xs" :class="sideTab==='vocab' ? 'bg-brand-600/15 border-brand-500/25 text-brand-200' : 'chip text-gray-200'">Vocab</button>
              <button @click="sideTab='memory'" class="px-3 py-2 rounded-xl border text-xs" :class="sideTab==='memory' ? 'bg-brand-600/15 border-brand-500/25 text-brand-200' : 'chip text-gray-200'">Memoria</button>
            </div>

            <div class="mt-4" v-if="sideTab==='tools'">
              <div class="text-[11px] uppercase text-gray-400 font-bold">Acciones r√°pidas</div>
              <div class="mt-2 space-y-2">
                <button @click="sendText('/define forklift')" class="w-full px-3 py-2 rounded-xl chip text-left text-sm hover:bg-ink-850">
                  <i class="fa-solid fa-book mr-2 text-emerald-300"></i> Definir: <span class="font-semibold">forklift</span>
                </button>
                <button @click="sendText('/wiki Warehouse')" class="w-full px-3 py-2 rounded-xl chip text-left text-sm hover:bg-ink-850">
                  <i class="fa-solid fa-globe mr-2 text-purple-300"></i> Wikipedia: <span class="font-semibold">Warehouse</span>
                </button>
                <button @click="sendText('/quiz safety')" class="w-full px-3 py-2 rounded-xl chip text-left text-sm hover:bg-ink-850">
                  <i class="fa-solid fa-list-check mr-2 text-brand-300"></i> Quiz: <span class="font-semibold">safety</span>
                </button>
                <button @click="mode='pron'" class="w-full px-3 py-2 rounded-xl bg-emerald-600/10 hover:bg-emerald-600/20 border border-emerald-500/20 text-left text-sm">
                  <i class="fa-solid fa-microphone mr-2 text-emerald-300"></i> Ir a Pronunciaci√≥n
                </button>
              </div>

              <div class="mt-4 p-3 rounded-xl bg-ink-950/40 border border-ink-700/40">
                <div class="flex items-center justify-between">
                  <div class="text-[11px] uppercase text-gray-400 font-bold">Python (Pyodide)</div>
                  <span class="text-[11px]" :class="pyReady ? 'text-emerald-300' : 'text-gray-500'">{{ pyReady ? 'Listo' : 'Off' }}</span>
                </div>
                <p class="text-[11px] text-gray-400 mt-1">Act√≠valo para resaltar frases (BM25) en lecturas de Wikipedia.</p>
                <button @click="togglePython" class="mt-2 w-full px-3 py-2 rounded-xl font-extrabold text-sm" :class="pyReady ? 'bg-red-600/15 border border-red-500/20 text-red-200' : 'bg-emerald-600/15 border border-emerald-500/20 text-emerald-200'">
                  {{ pyReady ? 'Desactivar Python' : 'Activar Python' }}
                </button>
              </div>
            </div>

            <div class="mt-4" v-if="sideTab==='notebook'">
              <div class="flex items-center justify-between">
                <div class="text-[11px] uppercase text-gray-400 font-bold">Notas guardadas</div>
                <button @click="clearNotebook" class="text-[11px] text-gray-400 hover:text-white">Limpiar</button>
              </div>
              <div v-if="notebook.length===0" class="text-sm text-gray-500 mt-2">A√∫n no guardas nada.</div>
              <div v-else class="mt-2 space-y-2">
                <div v-for="n in notebook" :key="n.id" class="p-3 rounded-xl bg-ink-950/40 border border-ink-700/40">
                  <div class="text-xs text-gray-200 font-semibold line-clamp-2">{{ n.title }}</div>
                  <div class="text-[11px] text-gray-400 line-clamp-3 mt-1">{{ n.preview }}</div>
                </div>
              </div>
            </div>

            <div class="mt-4" v-if="sideTab==='vocab'">
              <div class="flex items-center justify-between">
                <div class="text-[11px] uppercase text-gray-400 font-bold">Vocabulario</div>
                <button @click="clearVocab" class="text-[11px] text-gray-400 hover:text-white">Limpiar</button>
              </div>
              <div class="mt-2">
                <input v-model="vocabSearch" placeholder="Buscar..." class="w-full bg-ink-950/40 border border-ink-700/50 rounded-xl px-3 py-2 text-sm outline-none focus:border-brand-500" />
              </div>
              <div v-if="filteredVocab.length===0" class="text-sm text-gray-500 mt-2">No hay palabras guardadas.</div>
              <div v-else class="mt-2 space-y-2">
                <div v-for="w in filteredVocab" :key="w.word" class="p-3 rounded-xl bg-ink-950/40 border border-ink-700/40">
                  <div class="flex items-center justify-between">
                    <div class="text-sm font-bold text-white">{{ w.word }}</div>
                    <button @click="sendText('/define ' + w.word)" class="text-[11px] text-brand-200 hover:text-white">revisar</button>
                  </div>
                  <div class="text-[11px] text-gray-400 mt-1 line-clamp-2">{{ w.note }}</div>
                </div>
              </div>
            </div>

            <div class="mt-4" v-if="sideTab==='memory'">
              <div class="text-[11px] uppercase text-gray-400 font-bold">Memoria anti-repetici√≥n</div>
              <p class="text-[11px] text-gray-400 mt-2">Se guardan hashes por sesi√≥n (7 d√≠as) para evitar repetir frases.</p>
              <button @click="resetSeen" class="mt-3 w-full px-3 py-2 rounded-xl chip text-sm hover:bg-ink-850">Reset memoria</button>
            </div>

          </div>

          <div class="card p-4">
            <div class="text-[11px] uppercase text-gray-400 font-bold">Atajos</div>
            <div class="mt-2 text-sm text-gray-300 space-y-2">
              <div><span class="font-mono text-gray-200">/define word</span> ‚Äî definici√≥n + ejemplo + sin√≥nimos</div>
              <div><span class="font-mono text-gray-200">/wiki topic</span> ‚Äî lectura real + preguntas</div>
              <div><span class="font-mono text-gray-200">/quiz topic</span> ‚Äî quiz con respuestas</div>
              <div><span class="font-mono text-gray-200">/grammar tense</span> ‚Äî regla + ejercicios</div>
              <div><span class="font-mono text-gray-200">/python</span> ‚Äî activa Python (BM25)</div>
              <div><span class="font-mono text-gray-200">/export</span> ‚Äî exporta a .json</div>
            </div>
          </div>

        </div>
      </aside>

    </div>
  </main>

  <!-- MOBILE SIDE DRAWER -->
  <div v-if="sideOpen" class="fixed inset-0 z-50 bg-black/70 backdrop-blur-sm lg:hidden" @click.self="sideOpen=false">
    <div class="absolute right-0 top-0 h-full w-[92%] max-w-sm bg-ink-900 border-l border-ink-700/60 p-4 overflow-y-auto no-scrollbar">
      <div class="flex items-center justify-between">
        <div class="font-bold text-white">Panel</div>
        <button @click="sideOpen=false" class="w-9 h-9 rounded-full bg-ink-850 border border-ink-700/70 text-gray-300"><i class="fa-solid fa-xmark"></i></button>
      </div>

      <div class="mt-4 grid grid-cols-4 gap-2">
        <button @click="sideTab='tools'" class="px-2 py-2 rounded-xl border text-xs" :class="sideTab==='tools' ? 'bg-brand-600/15 border-brand-500/25 text-brand-200' : 'chip text-gray-200'">Tools</button>
        <button @click="sideTab='notebook'" class="px-2 py-2 rounded-xl border text-xs" :class="sideTab==='notebook' ? 'bg-brand-600/15 border-brand-500/25 text-brand-200' : 'chip text-gray-200'">Notas</button>
        <button @click="sideTab='vocab'" class="px-2 py-2 rounded-xl border text-xs" :class="sideTab==='vocab' ? 'bg-brand-600/15 border-brand-500/25 text-brand-200' : 'chip text-gray-200'">Vocab</button>
        <button @click="sideTab='memory'" class="px-2 py-2 rounded-xl border text-xs" :class="sideTab==='memory' ? 'bg-brand-600/15 border-brand-500/25 text-brand-200' : 'chip text-gray-200'">Memo</button>
      </div>

      <div class="mt-4 card p-4" v-if="sideTab==='tools'">
        <div class="text-[11px] uppercase text-gray-400 font-bold">Acciones r√°pidas</div>
        <div class="mt-2 space-y-2">
          <button @click="sendText('/define forklift'); sideOpen=false" class="w-full px-3 py-2 rounded-xl chip text-left text-sm hover:bg-ink-850"><i class="fa-solid fa-book mr-2 text-emerald-300"></i> Definir: <b>forklift</b></button>
          <button @click="sendText('/wiki Warehouse'); sideOpen=false" class="w-full px-3 py-2 rounded-xl chip text-left text-sm hover:bg-ink-850"><i class="fa-solid fa-globe mr-2 text-purple-300"></i> Wikipedia: <b>Warehouse</b></button>
          <button @click="sendText('/quiz safety'); sideOpen=false" class="w-full px-3 py-2 rounded-xl chip text-left text-sm hover:bg-ink-850"><i class="fa-solid fa-list-check mr-2 text-brand-300"></i> Quiz: <b>safety</b></button>
          <button @click="mode='pron'; sideOpen=false" class="w-full px-3 py-2 rounded-xl bg-emerald-600/10 hover:bg-emerald-600/20 border border-emerald-500/20 text-left text-sm"><i class="fa-solid fa-microphone mr-2 text-emerald-300"></i> Ir a Pronunciaci√≥n</button>
        </div>
        <div class="mt-4 p-3 rounded-xl bg-ink-950/40 border border-ink-700/40">
          <div class="flex items-center justify-between">
            <div class="text-[11px] uppercase text-gray-400 font-bold">Python (Pyodide)</div>
            <span class="text-[11px]" :class="pyReady ? 'text-emerald-300' : 'text-gray-500'">{{ pyReady ? 'Listo' : 'Off' }}</span>
          </div>
          <button @click="togglePython" class="mt-2 w-full px-3 py-2 rounded-xl font-extrabold text-sm" :class="pyReady ? 'bg-red-600/15 border border-red-500/20 text-red-200' : 'bg-emerald-600/15 border border-emerald-500/20 text-emerald-200'">{{ pyReady ? 'Desactivar Python' : 'Activar Python' }}</button>
        </div>
      </div>

      <div class="mt-4 card p-4" v-if="sideTab==='notebook'">
        <div class="flex items-center justify-between">
          <div class="text-[11px] uppercase text-gray-400 font-bold">Notas guardadas</div>
          <button @click="clearNotebook" class="text-[11px] text-gray-400 hover:text-white">Limpiar</button>
        </div>
        <div v-if="notebook.length===0" class="text-sm text-gray-500 mt-2">A√∫n no guardas nada.</div>
        <div v-else class="mt-2 space-y-2">
          <div v-for="n in notebook" :key="n.id" class="p-3 rounded-xl bg-ink-950/40 border border-ink-700/40">
            <div class="text-xs text-gray-200 font-semibold line-clamp-2">{{ n.title }}</div>
            <div class="text-[11px] text-gray-400 line-clamp-3 mt-1">{{ n.preview }}</div>
          </div>
        </div>
      </div>

      <div class="mt-4 card p-4" v-if="sideTab==='vocab'">
        <div class="flex items-center justify-between">
          <div class="text-[11px] uppercase text-gray-400 font-bold">Vocabulario</div>
          <button @click="clearVocab" class="text-[11px] text-gray-400 hover:text-white">Limpiar</button>
        </div>
        <div class="mt-2">
          <input v-model="vocabSearch" placeholder="Buscar..." class="w-full bg-ink-950/40 border border-ink-700/50 rounded-xl px-3 py-2 text-sm outline-none focus:border-brand-500" />
        </div>
        <div v-if="filteredVocab.length===0" class="text-sm text-gray-500 mt-2">No hay palabras guardadas.</div>
        <div v-else class="mt-2 space-y-2">
          <div v-for="w in filteredVocab" :key="w.word" class="p-3 rounded-xl bg-ink-950/40 border border-ink-700/40">
            <div class="flex items-center justify-between">
              <div class="text-sm font-bold text-white">{{ w.word }}</div>
              <button @click="sendText('/define ' + w.word); sideOpen=false" class="text-[11px] text-brand-200 hover:text-white">revisar</button>
            </div>
            <div class="text-[11px] text-gray-400 mt-1 line-clamp-2">{{ w.note }}</div>
          </div>
        </div>
      </div>

      <div class="mt-4 card p-4" v-if="sideTab==='memory'">
        <div class="text-[11px] uppercase text-gray-400 font-bold">Memoria anti-repetici√≥n</div>
        <p class="text-[11px] text-gray-400 mt-2">Se guardan hashes por sesi√≥n (7 d√≠as) para evitar repetir frases.</p>
        <button @click="resetSeen" class="mt-3 w-full px-3 py-2 rounded-xl chip text-sm hover:bg-ink-850">Reset memoria</button>
      </div>

    </div>
  </div>

  <!-- CONFIG MODAL -->
  <div v-if="showConfig" class="fixed inset-0 z-50 bg-black/80 backdrop-blur-sm flex items-end sm:items-center justify-center" @click.self="showConfig=false">
    <div class="bg-ink-900 w-full sm:max-w-lg rounded-t-3xl sm:rounded-2xl p-6 border-t border-ink-700/70 shadow-2xl">
      <div class="flex items-start justify-between">
        <div>
          <h3 class="text-lg font-extrabold text-white">Configuraci√≥n</h3>
          <p class="text-xs text-gray-400 mt-1">Todo corre en tu navegador. Fuentes externas solo si activas internet.</p>
        </div>
        <button @click="showConfig=false" class="w-9 h-9 rounded-full bg-ink-850 border border-ink-700/70 text-gray-300"><i class="fa-solid fa-xmark"></i></button>
      </div>

      <div class="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-3">
        <div>
          <label class="text-xs font-bold text-gray-400 uppercase block mb-2">Nombre (UI)</label>
          <input v-model="displayName" type="text" placeholder="Ej: Jes√∫s" class="w-full bg-ink-950/50 border border-ink-700/70 rounded-xl p-3 text-sm text-gray-200 outline-none focus:border-brand-500" />
        </div>
        <div>
          <label class="text-xs font-bold text-gray-400 uppercase block mb-2">Session ID (anti-repetici√≥n)</label>
          <input v-model="sessionId" type="text" placeholder="ej: jesus-01" class="w-full bg-ink-950/50 border border-ink-700/70 rounded-xl p-3 text-sm text-gray-200 outline-none focus:border-brand-500" />
        </div>
        <div>
          <label class="text-xs font-bold text-gray-400 uppercase block mb-2">Usar Internet</label>
          <button @click="useInternet=!useInternet" class="w-full px-3 py-3 rounded-xl text-sm font-extrabold border transition" :class="useInternet ? 'bg-emerald-600/15 text-emerald-200 border-emerald-500/20' : 'bg-yellow-600/15 text-yellow-200 border-yellow-500/20'">
            {{ useInternet ? 'Activado' : 'Desactivado' }}
          </button>
          <p class="text-[11px] text-gray-500 mt-2">Internet permite Wikipedia/Dictionary/Datamuse.</p>
        </div>
        <div>
          <label class="text-xs font-bold text-gray-400 uppercase block mb-2">Timeout API (ms)</label>
          <input v-model.number="timeoutMs" type="number" min="1500" max="20000" class="w-full bg-ink-950/50 border border-ink-700/70 rounded-xl p-3 text-sm text-gray-200 outline-none focus:border-brand-500" />
          <p class="text-[11px] text-gray-500 mt-2">Si tu conexi√≥n es lenta, sube a 12000‚Äì15000.</p>
        </div>
      </div>

      <div class="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-3">
        <div>
          <label class="text-xs font-bold text-gray-400 uppercase block mb-2">Idioma TTS (Chat)</label>
          <select v-model="ttsLang" class="w-full bg-ink-950/50 border border-ink-700/70 rounded-xl p-3 text-sm text-gray-200 outline-none focus:border-brand-500">
            <option value="en-US">en-US</option>
            <option value="en-GB">en-GB</option>
            <option value="es-MX">es-MX</option>
          </select>
        </div>
        <div>
          <label class="text-xs font-bold text-gray-400 uppercase block mb-2">Nivel</label>
          <select v-model="level" class="w-full bg-ink-950/50 border border-ink-700/70 rounded-xl p-3 text-sm text-gray-200 outline-none focus:border-brand-500">
            <option value="A2">A2 (b√°sico)</option>
            <option value="B1">B1 (intermedio)</option>
            <option value="B2">B2 (intermedio-alto)</option>
          </select>
        </div>
      </div>

      <div class="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-3">
        <div>
          <label class="text-xs font-bold text-gray-400 uppercase block mb-2">Idioma Pronunciaci√≥n (SpeechRecognition)</label>
          <select v-model="pronLang" class="w-full bg-ink-950/50 border border-ink-700/70 rounded-xl p-3 text-sm text-gray-200 outline-none focus:border-brand-500">
            <option value="en-US">en-US</option>
            <option value="en-GB">en-GB</option>
          </select>
          <p class="text-[11px] text-gray-500 mt-2">Recomendado: en-US o en-GB.</p>
        </div>
        <div>
          <label class="text-xs font-bold text-gray-400 uppercase block mb-2">Umbral ‚ÄúBien‚Äù (%)</label>
          <input v-model.number="passThreshold" type="number" min="50" max="95" class="w-full bg-ink-950/50 border border-ink-700/70 rounded-xl p-3 text-sm text-gray-200 outline-none focus:border-brand-500" />
          <p class="text-[11px] text-gray-500 mt-2">Por defecto 78%.</p>
        </div>
      </div>

      <div class="mt-5 flex gap-2">
        <button @click="saveConfig" class="flex-1 bg-brand-600 hover:bg-brand-500 text-white py-3 rounded-xl font-extrabold text-sm">Guardar</button>
        <button @click="resetAll" class="px-4 bg-red-600/15 hover:bg-red-600/20 text-red-200 border border-red-500/20 py-3 rounded-xl font-bold text-sm">Reset</button>
      </div>

      <div class="mt-4 text-[11px] text-gray-500 leading-relaxed">
        <b>Privacidad:</b> chat/notebook/vocab se guardan localmente. El reconocimiento de voz puede usar servicios del navegador.
      </div>
    </div>
  </div>

</div>

<script>
const { createApp, ref, computed, watch, nextTick, onMounted } = Vue;

createApp({
  setup(){
    // ===================== Core State =====================
    const displayName = ref(localStorage.getItem('ltult_name') || '');
    const mode = ref('chat'); // 'chat' | 'pron'
    const messages = ref([]);
    const input = ref('');
    const loading = ref(false);
    const showConfig = ref(false);
    const textarea = ref(null);
    const sideOpen = ref(false);
    const sideTab = ref('tools');

    const sessionId = ref(localStorage.getItem('ltult_session') || 'anon');
    const useInternet = ref(localStorage.getItem('ltult_use_internet') !== '0');
    const timeoutMs = ref(parseInt(localStorage.getItem('ltult_timeout') || '9000', 10));
    const internetOk = ref(true);
    const level = ref(localStorage.getItem('ltult_level') || 'B1');
    const ttsLang = ref(localStorage.getItem('ltult_tts_lang') || 'en-US');

    // pronunciation settings
    const pronLang = ref(localStorage.getItem('ltult_pron_lang') || 'en-US');
    const passThreshold = ref(parseInt(localStorage.getItem('ltult_pass_threshold') || '78', 10));

    const modeLabel = computed(() => mode.value === 'chat' ? 'Chat' : 'Pronunciaci√≥n');

    // storage (IndexedDB via localforage)
    localforage.config({ name: 'LinguaTutorULT', storeName: 'ltult' });
    const notebook = ref([]);
    const vocab = ref([]);
    const vocabSearch = ref('');

    // Python engine
    const pyReady = ref(false);
    const pyLoading = ref(false);
    let pyodide = null;

    // Voice input (dictation)
    const isVoiceInput = ref(false);
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let voiceRec = null;

    // ===================== Markdown safe render =====================
    marked.setOptions({ mangle:false, headerIds:false, breaks:true });
    const renderMD = (text) => DOMPurify.sanitize(marked.parse(text || ''));

    // ===================== Helpers =====================
    const sleep = (ms) => new Promise(r => setTimeout(r, ms));
    const statusLine = computed(() => {
      const bits = [];
      bits.push(useInternet.value ? 'internet:on' : 'internet:off');
      bits.push(pyReady.value ? 'python:on' : 'python:off');
      bits.push('nivel:' + level.value);
      return bits.join(' ‚Ä¢ ');
    });

    function toggleSide(){ sideOpen.value = !sideOpen.value; }

    function scrollToBottom(){
      nextTick(() => {
        const c = document.getElementById('chatScroll');
        if (c) c.scrollTop = c.scrollHeight;
      });
    }

    function copy(t){
      const txt = (t || '').replace(/\n\n+/g,'\n\n');
      navigator.clipboard?.writeText(txt).catch(()=>{});
    }

    function stripForTTS(md){
      return (md||'')
        .replace(/```[\s\S]*?```/g,' ')
        .replace(/`[^`]*`/g,' ')
        .replace(/\[(.*?)\]\((.*?)\)/g,'$1')
        .replace(/[#*_>]/g,' ')
        .replace(/\s+/g,' ')
        .trim();
    }

    function tts(text){
      const clean = stripForTTS(text);
      if(!clean) return;
      const u = new SpeechSynthesisUtterance(clean);
      u.lang = ttsLang.value;
      u.rate = 0.95;
      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(u);
    }

    function ttsPractice(text){
      const u = new SpeechSynthesisUtterance(String(text||''));
      u.lang = pronLang.value;
      u.rate = 0.92;
      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(u);
    }

    // ===================== Mobile fix: dynamic padding for input bar =====================
    function setupInputPaddingObserver(){
      const inputEl = document.getElementById('inputBar');
      if(!inputEl || !('ResizeObserver' in window)) return;
      const ro = new ResizeObserver(() => {
        const h = inputEl.getBoundingClientRect().height;
        document.documentElement.style.setProperty('--inputH', Math.ceil(h) + 'px');
      });
      ro.observe(inputEl);
      // initial
      const h0 = inputEl.getBoundingClientRect().height;
      document.documentElement.style.setProperty('--inputH', Math.ceil(h0) + 'px');
    }

    // ===================== Anti-repetition memory =====================
    const seenKey = () => `ltult_seen_${sessionId.value}`;
    function loadSeen(){
      try{
        const raw = localStorage.getItem(seenKey());
        const obj = raw ? JSON.parse(raw) : { ts: Date.now(), items: [] };
        const ttl = 7*24*60*60*1000;
        if(!obj.ts || !Array.isArray(obj.items)) return { ts: Date.now(), items: [] };
        if(Date.now() - obj.ts > ttl) return { ts: Date.now(), items: [] };
        return obj;
      }catch{ return { ts: Date.now(), items: [] }; }
    }
    function saveSeen(obj){ localStorage.setItem(seenKey(), JSON.stringify(obj)); }
    function remember(tag){
      const obj = loadSeen();
      const max = 2600;
      if(!obj.items.includes(tag)) obj.items.push(tag);
      while(obj.items.length > max) obj.items.shift();
      obj.ts = Date.now();
      saveSeen(obj);
    }
    function hasSeen(tag){ return loadSeen().items.includes(tag); }
    function hash32(s){
      s = String(s||'');
      let h = 2166136261;
      for(let i=0;i<s.length;i++){
        h ^= s.charCodeAt(i);
        h = Math.imul(h, 16777619);
      }
      return (h>>>0).toString(16);
    }
    function pickUnique(prefix, candidates){
      const shuffled = [...candidates].sort(()=>Math.random()-0.5);
      for(const c of shuffled){
        const tag = `${prefix}:${hash32(String(c).toLowerCase())}`;
        if(!hasSeen(tag)) { remember(tag); return c; }
      }
      const fb = candidates[Math.floor(Math.random()*candidates.length)];
      remember(`${prefix}:${hash32(String(fb).toLowerCase())}`);
      return fb;
    }
    function resetSeen(){ localStorage.removeItem(seenKey()); }

    // ===================== Fetch with timeout =====================
    async function fetchJson(url, opts={}){
      const ctrl = new AbortController();
      const id = setTimeout(()=>ctrl.abort(), timeoutMs.value);
      try{
        const res = await fetch(url, { ...opts, signal: ctrl.signal });
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        return await res.json();
      } finally { clearTimeout(id); }
    }

    // ===================== Providers =====================
    async function datamuseRelated(seed, max=18){
      const u = `https://api.datamuse.com/words?ml=${encodeURIComponent(seed)}&max=${max}`;
      const data = await fetchJson(u);
      return (data||[]).map(x=>x.word).filter(Boolean);
    }

    async function dictionaryDefine(word){
      const u = `https://api.dictionaryapi.dev/api/v2/entries/en/${encodeURIComponent(word)}`;
      try{
        const data = await fetchJson(u);
        const entry = Array.isArray(data) ? data[0] : null;
        if(!entry) return null;
        const m = (entry.meanings||[])[0] || {};
        const d = (m.definitions||[])[0] || {};
        return {
          word: entry.word || word,
          pos: m.partOfSpeech || '',
          definition: d.definition || '',
          example: d.example || '',
          synonyms: (d.synonyms||[]).slice(0,6)
        };
      }catch{ return null; }
    }

    async function wikipediaSearch(query, limit=5){
      const u = new URL('https://en.wikipedia.org/w/api.php');
      u.searchParams.set('action','opensearch');
      u.searchParams.set('format','json');
      u.searchParams.set('limit', String(limit));
      u.searchParams.set('origin','*');
      u.searchParams.set('search', query);
      const data = await fetchJson(u.toString());
      const titles = (data && data[1]) || [];
      return titles;
    }

    async function wikipediaExtract(title, sentences=5){
      const u = new URL('https://en.wikipedia.org/w/api.php');
      u.searchParams.set('action','query');
      u.searchParams.set('format','json');
      u.searchParams.set('prop','extracts');
      u.searchParams.set('explaintext','1');
      u.searchParams.set('exsentences', String(sentences));
      u.searchParams.set('origin','*');
      u.searchParams.set('titles', title);
      const data = await fetchJson(u.toString());
      const pages = data?.query?.pages || {};
      const first = Object.values(pages)[0];
      return first?.extract ? String(first.extract).trim() : null;
    }

    // ===================== Local fallback pools =====================
    const localTopics = ['work','travel','food','family','shopping','health','sports','time','safety'];
    const localWordBank = {
      work: ['meeting','shift','deadline','warehouse','forklift','pallet','supervisor','inventory','schedule','overtime'],
      travel: ['ticket','station','passport','hotel','luggage','schedule','gate','platform','reservation'],
      food: ['breakfast','spicy','recipe','ingredients','coffee','dessert','order','water','vegetables'],
      safety: ['helmet','gloves','warning','careful','danger','safe','training','procedure','hazard'],
      family: ['cousin','uncle','aunt','brother','sister','parents','kids','neighbors'],
      shopping: ['price','discount','receipt','size','cash','card','expensive','cheap'],
      health: ['doctor','medicine','pain','sleep','exercise','healthy','sick','clinic'],
      sports: ['team','score','practice','match','coach','player','win','lose'],
      time: ['today','tomorrow','yesterday','early','late','minutes','hours','weekend']
    };
    const rand = (arr) => arr[Math.floor(Math.random()*arr.length)];

    // ===================== Intent Parsing =====================
    function parseCommand(text){
      const t = (text||'').trim();
      if(!t.startsWith('/')) return null;
      const [cmd, ...rest] = t.slice(1).split(/\s+/);
      return { cmd: (cmd||'').toLowerCase(), args: rest.join(' ').trim() };
    }

    function guessTopic(text){
      const t = (text||'').toLowerCase();
      if(/work|trabaj|almac[e√©]n|warehouse|forklift|pallet/.test(t)) return 'work';
      if(/travel|viaj|flight|airport|hotel|bus|train/.test(t)) return 'travel';
      if(/food|comida|coffee|restaurant|order|spicy/.test(t)) return 'food';
      if(/safety|seguridad|ppe|helmet|gloves|hazard/.test(t)) return 'safety';
      return rand(localTopics);
    }

    function classifyIntent(text){
      const t = (text||'').toLowerCase();
      const weights = {
        define: [/\bdefine\b|\bdefin|\bsignificado\b|\bmeaning\b/],
        wiki: [/\bwiki\b|\bwikipedia\b|\blectura\b|\breading\b|\bart[i√≠]culo\b|\btexto\b/],
        quiz: [/\bquiz\b|\bejercicio\b|\btest\b|\bpracticar\b|\bactividad\b|\bexercises?\b/],
        grammar: [/\bgram\w+|\btiempo\s*verbal\b|\bpasado\b|\bpresente\b|\bfuturo\b|\bverb\b/],
        plan: [/\bplan\b|\brutina\b|\b7\s*d[i√≠]as\b|\bestudio\b/],
        general: [/.*/]
      };
      for(const k of ['define','wiki','quiz','grammar','plan']){
        if(weights[k].some(r => r.test(t))) return k;
      }
      return 'general';
    }

    // ===================== Python (Pyodide) Engine =====================
    const PY_BOOT = `
import re, math

def _tok(s):
  s=(s or '').lower()
  s=re.sub(r"[^a-z0-9\s']"," ",s)
  s=re.sub(r"\s+"," ",s).strip()
  return [w for w in s.split(' ') if w]

class BM25:
  def __init__(self, docs, k1=1.5, b=0.75):
    self.docs=[_tok(d) for d in docs]
    self.k1=k1; self.b=b
    self.N=len(self.docs)
    self.df={}
    self.avgdl=sum(len(d) for d in self.docs)/(self.N or 1)
    for d in self.docs:
      for w in set(d):
        self.df[w]=self.df.get(w,0)+1
  def idf(self,w):
    n=self.df.get(w,0)
    return math.log(1+(self.N-n+0.5)/(n+0.5))
  def score(self, q, idx):
    q=_tok(q)
    d=self.docs[idx]
    if not d: return 0.0
    freqs={}
    for w in d: freqs[w]=freqs.get(w,0)+1
    dl=len(d)
    s=0.0
    for w in q:
      if w not in freqs: continue
      f=freqs[w]
      idf=self.idf(w)
      denom=f+self.k1*(1-self.b+self.b*dl/self.avgdl)
      s += idf*(f*(self.k1+1))/denom
    return s
  def topk(self, q, k=3):
    scores=[(self.score(q,i), i) for i in range(self.N)]
    scores.sort(reverse=True)
    return scores[:k]
`;

    async function initPython(){
      if(pyReady.value || pyLoading.value) return;
      pyLoading.value = true;
      try{
        pyodide = await loadPyodide({ indexURL: 'https://cdn.jsdelivr.net/pyodide/v0.25.1/full/' });
        await pyodide.runPythonAsync(PY_BOOT);
        pyReady.value = true;
      }catch(e){
        console.warn('Pyodide init failed', e);
        pyReady.value = false;
      } finally {
        pyLoading.value = false;
      }
    }

    async function pyTopSentences(question, text, k=3){
      const sents = (text||'').split(/(?<=[.!?])\s+/).filter(s => s.trim().length>20);
      if(!pyReady.value || !pyodide || sents.length===0) return sents.slice(0,k);
      try{
        pyodide.globals.set('DOCS', sents);
        pyodide.runPython('bm = BM25(DOCS)');
        pyodide.globals.set('Q', question);
        const top = pyodide.runPython(`bm.topk(Q, ${k})`);
        const out = [];
        for(const t of top){ out.push(sents[t[1]]); }
        return out;
      }catch(e){
        console.warn('pyTopSentences failed', e);
        return sents.slice(0,k);
      }
    }

    // ===================== Notebook & Vocab =====================
    async function loadNotebook(){
      const data = (await localforage.getItem('notebook')) || [];
      notebook.value = Array.isArray(data) ? data : [];
    }
    async function loadVocab(){
      const data = (await localforage.getItem('vocab')) || [];
      vocab.value = Array.isArray(data) ? data : [];
    }
    async function saveNotebook(){ await localforage.setItem('notebook', notebook.value); }
    async function saveVocab(){ await localforage.setItem('vocab', vocab.value); }

    function pinToNotebook(msg){
      const title = stripForTTS(msg.text).slice(0,80) || 'Nota';
      const preview = stripForTTS(msg.text).slice(0,160);
      notebook.value.unshift({ id: Date.now(), title, preview, ts: Date.now() });
      notebook.value = notebook.value.slice(0, 100);
      saveNotebook();
    }

    function addVocab(word, note){
      word = (word||'').trim();
      if(!word) return;
      const key = word.toLowerCase();
      const existing = vocab.value.find(v=>v.word.toLowerCase()===key);
      if(existing){ existing.note = note || existing.note; existing.ts = Date.now(); }
      else vocab.value.unshift({ word, note: note||'', ts: Date.now() });
      vocab.value = vocab.value.slice(0, 250);
      saveVocab();
    }

    function clearNotebook(){ notebook.value = []; saveNotebook(); }
    function clearVocab(){ vocab.value = []; saveVocab(); }

    const filteredVocab = computed(() => {
      const q = vocabSearch.value.trim().toLowerCase();
      if(!q) return vocab.value;
      try{
        const fuse = new Fuse(vocab.value, { keys:['word','note'], threshold: 0.35 });
        return fuse.search(q).map(r=>r.item);
      }catch{ return vocab.value.filter(v => (v.word+" "+v.note).toLowerCase().includes(q)); }
    });

    // ===================== Content Builders =====================
    function mdTable(rows){
      const [h1,h2] = rows[0];
      const lines = [];
      lines.push(`| ${h1} | ${h2} |`);
      lines.push(`| --- | --- |`);
      for(let i=1;i<rows.length;i++){
        const [a,b]=rows[i];
        lines.push(`| ${a} | ${b} |`);
      }
      return lines.join('\n');
    }

    function grammarPack(tense){
      const t = (tense||'').toLowerCase();
      const packs = {
        'past simple': {
          title:'Past Simple (pasado simple)',
          explain:`Se usa para acciones terminadas en el pasado.\n\n- Regular: play ‚Üí **played**\n- Irregular: go ‚Üí **went**\n\n**Marcadores**: yesterday, last week, ago.`,
          ex:[
            "Completa: 1) I ___ (work) yesterday. 2) She ___ (go) home. 3) They ___ (not/like) it.",
            "Convierte: 'He visited the warehouse.' ‚Üí negativa y pregunta.",
            "Corrige: 'She go to work last Monday.'"
          ]
        },
        'present perfect': {
          title:'Present Perfect',
          explain:`Conecta pasado con presente.\n\n- **have/has + past participle**\n- I **have worked** / She **has worked**\n\n**Marcadores**: already, yet, ever, never, since, for.`,
          ex:[
            "Completa: 1) I have ___ (finish) my shift. 2) She has ___ (not/see) it yet.",
            "Elige: 'Have you ever / Did you ever' been to Mexico?",
            "Escribe 2 oraciones con **since** y **for**."
          ]
        },
        'present simple': {
          title:'Present Simple (h√°bitos)',
          explain:`Rutinas y hechos.\n\n- I/you/we/they work\n- he/she/it work**s**\n\nTip: agrega **-s** solo en he/she/it.`,
          ex:[
            "Completa: 1) He ___ (work) here. 2) They ___ (not/watch) TV. 3) ___ you ___ (study) English?",
            "Convierte a pregunta: 'She works at a warehouse.'",
            "Corrige: 'He don't like it.'"
          ]
        }
      };
      return packs[t] || packs['present simple'];
    }

    function buildQuiz(topic, words){
      const lvl = level.value;
      const chosen = words.slice(0,6);
      const w1 = chosen[0] || 'work';
      const w2 = chosen[1] || 'shift';
      const w3 = chosen[2] || 'safety';

      const mcq = [
        { q:`(1) ¬øCu√°l frase suena m√°s natural para pedir ayuda?`,
          a:[`Can you help me with this ${w1}?`,`Can you aid me with this ${w1}?`,`Can you assistance me with this ${w1}?`],
          ok:0
        },
        { q:`(2) Elige la forma correcta (nivel ${lvl}):`,
          a:[`He work in the warehouse.`,`He works in the warehouse.`,`He working in the warehouse.`],
          ok:1
        },
        { q:`(3) Traduce: ‚ÄúTengo mi pr√≥ximo turno ma√±ana.‚Äù`,
          a:[`I have my next shift tomorrow.`,`I has my next shift tomorrow.`,`I am have my next shift tomorrow.`],
          ok:0
        }
      ];

      const gap = `Completa (usa: **${w2}**, **${w3}**):\n\n1) My ____ starts at 7 a.m.\n2) ____ first. Wear your helmet.`;

      const answerKey = [
        `1) ${mcq[0].a[mcq[0].ok]}`,
        `2) ${mcq[1].a[mcq[1].ok]}`,
        `3) ${mcq[2].a[mcq[2].ok]}`,
        `Gap: 1) ${w2}  2) Safety`
      ].join('\n');

      const table = mdTable([
        ['Palabra','Uso r√°pido'],
        [w1, `I need a **${w1}** today.`],
        [w2, `My **${w2}** starts at 7.`],
        [w3, `**${w3}** first.`],
      ]);

      return {
        md: `### üìù Quiz (${topic})\n\n${table}\n\n---\n#### 1) Multiple choice\n${mcq.map(x=>`- ${x.q}\n  - A) ${x.a[0]}\n  - B) ${x.a[1]}\n  - C) ${x.a[2]}\n`).join('\n')}\n---\n#### 2) Fill in the blanks\n${gap}\n\n---\n#### ‚úÖ Respuestas\n\n${answerKey}\n\nüí° Si quieres, responde t√∫ primero y te corrijo.`
      };
    }

    function buildDefineMD(def){
      if(!def) return { md: "### ‚ö†Ô∏è No encontr√© definici√≥n\n\nIntenta otra palabra o activa Internet.", sources: [] };
      const syn = def.synonyms?.length ? def.synonyms.map(s=>`\`${s}\``).join(', ') : '‚Äî';
      const ex = def.example ? `> _${def.example}_` : '> _(sin ejemplo disponible)_';
      addVocab(def.word, def.definition || '');
      return {
        md:
`### üìò Definici√≥n\n\n**Palabra:** \`${def.word}\`${def.pos ? ` (${def.pos})` : ''}\n\n**Meaning:** ${def.definition || '‚Äî'}\n\n**Example:**\n${ex}\n\n**Synonyms:** ${syn}\n\n---\n**Mini-pr√°ctica**\n1) Escribe 2 oraciones con \`${def.word}\`.\n2) Dime un sin√≥nimo y en qu√© cambia el significado.\n\nüéß Tip: usa "Escuchar" para o√≠r la palabra en contexto.`,
        sources: [{ title:'DictionaryAPI', url:'https://dictionaryapi.dev/', snippet:`${def.word}: ${def.definition || ''}` }]
      };
    }

    async function buildWikiMD(topic){
      const sources = [];
      let title = topic;
      if(useInternet.value){
        try{
          internetOk.value = true;
          const sugg = await wikipediaSearch(topic, 5);
          if(sugg && sugg.length) title = sugg[0];
          const extract = await wikipediaExtract(title, 7);
          sources.push({ title: `Wikipedia: ${title}`, url: `https://en.wikipedia.org/wiki/${encodeURIComponent(title.replace(/\s+/g,'_'))}`, snippet: (extract||'').slice(0,220) });

          const q = `What is ${title}? key facts`;
          const highlights = extract ? await pyTopSentences(q, extract, 3) : [];

          const words = (extract||'').toLowerCase().match(/[a-z]{5,}/g) || [];
          const uniq = [...new Set(words)].slice(0, 50);
          const picks = uniq.length ? [pickUnique('wk_vocab', uniq), pickUnique('wk_vocab', uniq), pickUnique('wk_vocab', uniq)] : ['concept','process','example'];
          const vocabLines = picks.map(w => `- \`${w}\` ‚Äî (usa /define ${w})`).join('\n');

          const md = `### üìñ Lectura real (Wikipedia)\n\n**Tema:** ${title}\n\n> ${extract || 'No pude obtener el extracto. Intenta otro tema.'}\n\n---\n#### ‚ú® Frases clave (selecci√≥n inteligente)\n${highlights.length ? highlights.map(s=>`- ${s}`).join('\n') : '_Activa Python para resaltar frases autom√°ticamente._'}\n\n---\n#### ‚úÖ Actividades (nuevas)\n1) Resume el texto en **1 oraci√≥n en ingl√©s**.\n2) Escribe **3 palabras nuevas** del texto y tu traducci√≥n aproximada.\n3) Escribe una pregunta (en ingl√©s) sobre el tema.\n\n---\n#### üß† Vocab sugerido\n${vocabLines}`;
          return { md, sources };
        } catch(e){
          internetOk.value = false;
        }
      }
      internetOk.value = false;
      const mini = [
        `Today I want to learn about **${guessTopic(topic)}**.`,
        `I will practice short sentences and new words.`,
        `My goal is to speak with confidence.`
      ].sort(()=>Math.random()-0.5).join(' ');
      const md = `### üü° Lectura (Local)\n\n> ${mini}\n\n---\n#### ‚úÖ Actividades\n1) Subraya 3 palabras clave.\n2) Escribe 1 oraci√≥n en pasado.\n3) Escribe 1 pregunta en ingl√©s.`;
      return { md, sources: [] };
    }

    async function buildGeneralMD(userText){
      const topic = guessTopic(userText);
      const sources = [];
      let word = '';
      let def = null;

      if(useInternet.value){
        try{
          internetOk.value = true;
          const related = await datamuseRelated(userText.length>2 ? userText : topic, 24);
          const pool = related.length ? related : (localWordBank[topic] || localWordBank.work);
          word = pickUnique('word', pool);
          def = await dictionaryDefine(word);
          sources.push({ title: 'Datamuse', url: 'https://api.datamuse.com', snippet: `seed: ${userText} ‚Üí ${word}` });
          if(def?.definition) sources.push({ title: 'DictionaryAPI', url: 'https://dictionaryapi.dev/', snippet: `${def.word}: ${def.definition}` });
        } catch { internetOk.value = false; }
      }

      if(!word){
        internetOk.value = false;
        const pool = (localWordBank[topic] || localWordBank.work);
        word = pickUnique('local_word', pool);
      }

      const baseSentence = def?.example || `I need a ${word} today.`;
      const phrases = [
        [`Can you help me with this ${word}?`, `¬øMe ayudas con este/esta ${word}?`],
        [`I need to ${rand(['buy','find','use','check'])} a ${word}.`, `Necesito ${rand(['comprar','encontrar','usar','revisar'])} un/una ${word}.`],
        [`Let's talk about ${topic}.`, `Hablemos de ${topic}.`],
      ];

      const table = mdTable([['English','Espa√±ol'], ...phrases]);

      const exType = pickUnique('ex_type', ['gap','translate','scramble','error','roleplay']);
      let ex = '';
      if(exType==='gap'){
        ex = `**Fill in the blank:**\n\n${baseSentence.replace(new RegExp(`\\b${word}\\b`,'i'),'_____')}\n\n‚úÖ Respuesta: **${word}**`;
      } else if(exType==='translate'){
        ex = `**Traduce al ingl√©s:**\n\n> "Necesito un/una **${word}** hoy."\n\nTip: usa \`${word}\`.`;
      } else if(exType==='scramble'){
        const scrambled = baseSentence.split(' ').sort(()=>Math.random()-0.5).join(' / ');
        ex = `**Ordena las palabras:**\n\n${scrambled}\n\n‚úÖ Soluci√≥n: _${baseSentence}_`;
      } else if(exType==='roleplay'){
        ex = `**Roleplay (2 turnos):**\n\nA) Pide ayuda para resolver un problema con **${word}**.\nB) Responde con 2 opciones y una pregunta.`;
      } else {
        ex = `**Detecta el error:**\n\n> He go to the ${word} yesterday.\n\n‚úÖ Correcci√≥n: **He went to the ${word} yesterday.**`;
      }

      if(def?.definition) addVocab(def.word, def.definition);
      else addVocab(word, `Relacionado con ${topic}`);

      const md = `### üß© Respuesta (con fuentes y variaci√≥n)\n\n**Tema detectado:** ${topic}  \n**Palabra clave:** \`${def?.word || word}\`${def?.pos ? ` (${def.pos})` : ''}\n\n${def?.definition ? `**Meaning:** ${def.definition}\n\n` : ''}${def?.example ? `**Example:**\n> _${def.example}_\n\n` : ''}---\n#### üí¨ Mini-frases\n${table}\n\n---\n#### üìù Ejercicio\n${ex}\n\n---\nüéôÔ∏è Tip: cambia al modo **Pronunciaci√≥n** para practicar hablando.`;

      return { md, sources };
    }

    async function buildGrammarMD(tense){
      const pack = grammarPack(tense);
      const ex = pack.ex.sort(()=>Math.random()-0.5);
      const md = `### üìö Gram√°tica PRO: ${pack.title}\n\n${pack.explain}\n\n---\n#### üß™ Ejercicios (variados)\n1) ${ex[0]}\n\n2) ${ex[1]}\n\n3) ${ex[2]}\n\n---\n‚úÖ Escribe tus respuestas y te doy retroalimentaci√≥n.`;
      return { md, sources: [] };
    }

    async function buildPlanMD(){
      const md = `### üóìÔ∏è Plan de 7 d√≠as (ingl√©s para trabajo)\n\n**Objetivo:** mejorar comunicaci√≥n y seguridad (15‚Äì20 min/d√≠a).\n\n1) D√≠a 1: /define warehouse, forklift, shift\n2) D√≠a 2: preguntas √∫tiles (Where is‚Ä¶? Can you‚Ä¶?)\n3) D√≠a 3: /grammar past simple\n4) D√≠a 4: /quiz safety\n5) D√≠a 5: mini reportes + conectores (because/so/but)\n6) D√≠a 6: modo Pronunciaci√≥n (10 frases)\n7) D√≠a 7: simulaci√≥n + /export\n\nSi me dices tu √°rea (montacargas, surtido, embarques) lo personalizo.`;
      return { md, sources: [] };
    }

    // ===================== Orchestrator =====================
    async function buildAI(userText){
      const cmd = parseCommand(userText);
      const intent = cmd ? cmd.cmd : classifyIntent(userText);

      if(cmd){
        const args = cmd.args || '';
        if(intent==='define'){
          const w = args || pickUnique('rand_word', localWordBank[guessTopic(userText)]);
          if(useInternet.value){
            try{ internetOk.value = true; return buildDefineMD(await dictionaryDefine(w)); }
            catch{ internetOk.value = false; }
          }
          internetOk.value = false;
          return { md: `### üìò Definici√≥n (Local)\n\n**Palabra:** \`${w}\`\n\nEjemplo: _I need a ${w} today._\n\nTip: activa Internet para definici√≥n real.`, sources: [] };
        }

        if(intent==='wiki') return await buildWikiMD(args || guessTopic(userText));

        if(intent==='quiz'){
          const topic = (args || guessTopic(userText));
          let pool = (localWordBank[topic.toLowerCase()] || localWordBank[guessTopic(topic)] || localWordBank.work);
          if(useInternet.value){
            try{ internetOk.value = true; const related = await datamuseRelated(topic, 22); if(related.length) pool = related; }
            catch{ internetOk.value = false; }
          }
          const words = [];
          while(words.length < Math.min(10, pool.length)){
            const w = pickUnique('quiz_word', pool);
            if(!words.includes(w)) words.push(w);
          }
          const quiz = buildQuiz(topic, words);
          return { md: quiz.md, sources: [{ title:'Datamuse / local wordbank', url:'https://api.datamuse.com', snippet:`topic: ${topic}` }] };
        }

        if(intent==='grammar') return await buildGrammarMD(args || 'present simple');

        if(intent==='plan') return await buildPlanMD();

        if(intent==='export') return exportAll();

        if(intent==='python'){
          await initPython();
          return { md: pyReady.value ? '### üêç Python activado\n\nListo. Lecturas resaltan frases con BM25.' : '### ‚ö†Ô∏è No pude iniciar Python\n\nRevisa tu conexi√≥n o bloqueadores.', sources: [] };
        }

        return { md: `### ‚ö†Ô∏è Comando no reconocido\n\nPrueba: /define, /wiki, /quiz, /grammar, /python, /export`, sources: [] };
      }

      if(intent==='wiki') return await buildWikiMD(userText);
      if(intent==='grammar') return await buildGrammarMD(userText);
      if(intent==='quiz') return await buildAI(`/quiz ${guessTopic(userText)}`);
      if(intent==='plan') return await buildPlanMD();
      if(intent==='define'){
        const w = (userText.match(/[A-Za-z]{3,}$/) || [])[0] || pickUnique('rand_word', localWordBank[guessTopic(userText)]);
        return await buildAI(`/define ${w}`);
      }
      return await buildGeneralMD(userText);
    }

    // ===================== Export =====================
    function download(filename, text){
      const blob = new Blob([text], { type: 'application/json;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function exportAll(){
      const payload = {
        version: 'LinguaTutorULT-HTML-1.0',
        ts: new Date().toISOString(),
        sessionId: sessionId.value,
        messages: messages.value,
        notebook: notebook.value,
        vocab: vocab.value,
        settings: {
          useInternet: useInternet.value,
          timeoutMs: timeoutMs.value,
          level: level.value,
          ttsLang: ttsLang.value,
          pronLang: pronLang.value,
          passThreshold: passThreshold.value
        }
      };
      download(`ltult_export_${Date.now()}.json`, JSON.stringify(payload, null, 2));
      return { md: '### ‚úÖ Exportado\n\nDescargu√© un archivo **.json** con tu chat, notebook y vocabulario.', sources: [] };
    }

    // ===================== Chat actions =====================
    const send = async () => {
      const text = input.value.trim();
      if(!text) return;
      input.value = '';
      if(textarea.value) textarea.value.style.height = 'auto';

      messages.value.push({ id: Date.now(), role:'user', text });
      loading.value = true;
      scrollToBottom();
      await sleep(140);

      let out;
      try{
        if(useInternet.value) internetOk.value = true;
        out = await buildAI(text);
      }catch(e){
        internetOk.value = false;
        out = { md: '### ‚ö†Ô∏è Error\n\nNo pude generar respuesta. Intenta de nuevo o desactiva Internet.', sources: [] };
      }

      messages.value.push({ id: Date.now()+1, role:'ai', text: out.md, sources: out.sources || [], showSources: false });
      loading.value = false;
      scrollToBottom();

      localforage.setItem('messages', messages.value).catch(()=>{});
    };

    const sendText = (t) => { input.value = t; send(); };

    const regenerate = async (msg) => {
      const idx = messages.value.findIndex(m => m.id === msg.id);
      if(idx <= 0) return;
      const prevUser = [...messages.value].slice(0, idx).reverse().find(m => m.role==='user');
      if(!prevUser) return;
      loading.value = true;
      await sleep(120);
      const out = await buildAI(prevUser.text + ' (var√≠a y no repitas)');
      messages.value.splice(idx, 1, { id: Date.now(), role:'ai', text: out.md, sources: out.sources || [], showSources:false });
      loading.value = false;
      scrollToBottom();
    };

    watch(input, () => {
      if(textarea.value){
        textarea.value.style.height = 'auto';
        textarea.value.style.height = Math.min(textarea.value.scrollHeight, 160) + 'px';
      }
    });

    // ===================== Dictation =====================
    function toggleVoiceInput(){
      if(!SpeechRecognition){
        messages.value.push({ id: Date.now()+9, role:'ai', text: '### ‚ö†Ô∏è Dictado no disponible\n\nTu navegador no soporta SpeechRecognition para dictado.', sources: [], showSources:false });
        return;
      }
      isVoiceInput.value = !isVoiceInput.value;
      if(isVoiceInput.value){
        voiceRec = new SpeechRecognition();
        voiceRec.lang = 'es-MX';
        voiceRec.continuous = true;
        voiceRec.interimResults = true;
        voiceRec.onresult = (ev) => {
          let transcript = '';
          for(let i=ev.resultIndex;i<ev.results.length;i++) transcript += ev.results[i][0].transcript;
          input.value = transcript;
        };
        voiceRec.onerror = () => { isVoiceInput.value = false; };
        voiceRec.onend = () => { if(isVoiceInput.value) voiceRec.start(); };
        try{ voiceRec.start(); }catch{ isVoiceInput.value=false; }
      } else {
        try{ voiceRec && voiceRec.stop(); }catch{}
      }
    }

    // ===================== Config =====================
    function saveConfig(){
      localStorage.setItem('ltult_name', displayName.value || '');
      localStorage.setItem('ltult_session', sessionId.value || 'anon');
      localStorage.setItem('ltult_use_internet', useInternet.value ? '1' : '0');
      localStorage.setItem('ltult_timeout', String(timeoutMs.value || 9000));
      localStorage.setItem('ltult_level', level.value || 'B1');
      localStorage.setItem('ltult_tts_lang', ttsLang.value || 'en-US');
      localStorage.setItem('ltult_pron_lang', pronLang.value || 'en-US');
      localStorage.setItem('ltult_pass_threshold', String(passThreshold.value || 78));
      showConfig.value = false;
    }

    async function resetAll(){
      for(const k of ['ltult_name','ltult_session','ltult_use_internet','ltult_timeout','ltult_level','ltult_tts_lang','ltult_pron_lang','ltult_pass_threshold']) localStorage.removeItem(k);
      resetSeen();
      messages.value = [];
      notebook.value = [];
      vocab.value = [];
      await localforage.clear();
      showConfig.value = false;
    }

    async function togglePython(){
      if(pyReady.value){ pyReady.value = false; pyodide = null; return; }
      await initPython();
    }

    // ===================== Pronunciation Engine =====================
    const speechSupported = ref(!!SpeechRecognition);
    const practiceTopic = ref(localStorage.getItem('ltult_pron_topic') || 'work');
    const practiceList = ref([]);
    const currentIndex = ref(0);

    const isRecording = ref(false);
    const recBusy = ref(false);
    const lastAudioUrl = ref('');
    const lastTranscript = ref('');
    const recStateLabel = ref('Listo');

    let mediaStream = null;
    let mediaRecorder = null;
    let recordedChunks = [];
    let recognition = null;

    const currentItem = computed(() => practiceList.value[currentIndex.value] || { text:'', score:null, passed:false, transcript:'' });

    const doneCount = computed(() => practiceList.value.filter(x => x.score !== null).length);
    const overallScore = computed(() => {
      const done = practiceList.value.filter(x => x.score !== null);
      if(!done.length) return 0;
      return Math.round(done.reduce((a,b)=>a + b.score, 0) / done.length);
    });
    const overallScoreColor = computed(() => {
      const s = overallScore.value;
      if(s >= passThreshold.value) return 'text-emerald-300';
      if(s >= Math.max(60, passThreshold.value - 10)) return 'text-yellow-300';
      return 'text-red-400';
    });

    function scoreColor(score){
      if(score === null || score === undefined) return 'text-gray-500';
      if(score >= passThreshold.value) return 'text-emerald-300';
      if(score >= Math.max(60, passThreshold.value - 10)) return 'text-yellow-300';
      return 'text-red-400';
    }

    function rowClass(it, idx){
      const base = idx === currentIndex.value ? 'border-brand-500/40 bg-brand-600/10' : 'border-ink-700/50 bg-ink-950/30';
      if(it.score === null) return base;
      if(it.passed) return (idx === currentIndex.value) ? 'border-emerald-500/50 bg-emerald-600/10' : 'border-emerald-500/25 bg-emerald-600/5';
      return (idx === currentIndex.value) ? 'border-red-500/50 bg-red-600/10' : 'border-red-500/25 bg-red-600/5';
    }

    const nextPractice = () => { if(currentIndex.value < practiceList.value.length - 1) { currentIndex.value++; clearRecording(); } };
    const prevPractice = () => { if(currentIndex.value > 0) { currentIndex.value--; clearRecording(); } };

    const resetPracticeScores = () => {
      practiceList.value = practiceList.value.map(x => ({ ...x, score:null, passed:false, transcript:'' }));
      clearRecording();
    };

    // Text normalization + Levenshtein on tokens
    const normalize = (s) => (s||'')
      .toLowerCase()
      .replace(/[\u2019']/g, "'")
      .replace(/[^a-z0-9\s']/g, ' ')
      .replace(/\s+/g, ' ')
      .trim();
    const tokenize = (s) => normalize(s).split(' ').filter(Boolean);

    function levenshtein(a, b){
      const m=a.length, n=b.length;
      const dp = Array.from({length:m+1}, ()=> new Array(n+1).fill(0));
      for(let i=0;i<=m;i++) dp[i][0]=i;
      for(let j=0;j<=n;j++) dp[0][j]=j;
      for(let i=1;i<=m;i++){
        for(let j=1;j<=n;j++){
          const cost = a[i-1]===b[j-1] ? 0 : 1;
          dp[i][j] = Math.min(
            dp[i-1][j] + 1,
            dp[i][j-1] + 1,
            dp[i-1][j-1] + cost
          );
        }
      }
      return dp[m][n];
    }

    function similarityPercent(target, spoken){
      const ta = tokenize(target);
      const sa = tokenize(spoken);
      if(!ta.length && !sa.length) return 100;
      if(!ta.length || !sa.length) return 0;
      const dist = levenshtein(ta, sa);
      const denom = Math.max(ta.length, sa.length);
      const sim = Math.max(0, 1 - (dist/denom));
      return Math.round(sim*100);
    }

    async function generatePracticeSentences(topic, count=8){
      const t = (topic||'').trim() || rand(localTopics);
      const base = t.toLowerCase();
      if(useInternet.value){
        try{
          internetOk.value = true;
          const related = await datamuseRelated(base, 40);
          const pool = related.length ? related : (localWordBank[base] || localWordBank.work);
          const words = [];
          while(words.length < Math.min(12, pool.length)){
            const w = pickUnique('pron_word', pool);
            if(!words.includes(w)) words.push(w);
          }
          const templates = [
            (w)=>`I need a ${w} right now.`,
            (w)=>`Can you help me with the ${w}?`,
            (w)=>`Please speak slowly and clearly.`,
            (w)=>`I am ready for my next shift.`,
            (w)=>`Safety first. Wear your ${w}.`,
            (w)=>`Could you repeat that, please?`,
            (w)=>`Where is the nearest ${w}?`,
            (w)=>`I will practice English every day.`
          ];
          const sentences = [];
          for(let i=0;i<count;i++){
            const w = rand(words) || rand(pool);
            let sent = '';
            if(Math.random() < 0.35){
              const def = await dictionaryDefine(w);
              if(def?.example && def.example.length <= 90) sent = def.example;
            }
            if(!sent) sent = rand(templates)(w);
            const tag = `pron_sent:${hash32(normalize(sent))}`;
            if(hasSeen(tag)) { i--; continue; }
            remember(tag);
            sentences.push(sent);
          }
          return sentences;
        }catch{ internetOk.value = false; }
      }

      internetOk.value = false;
      const pool = localWordBank[base] || localWordBank.work;
      const templates = [
        (w)=>`I need a ${w} today.`,
        (w)=>`Please be careful and stay safe.`,
        (w)=>`Can you repeat that, please?`,
        (w)=>`I will practice my pronunciation.`,
        (w)=>`I am ready to start my shift.`,
        (w)=>`Let's work as a team.`,
        (w)=>`Where can I find the ${w}?`,
        (w)=>`Thank you for your help.`
      ];
      const sentences = [];
      for(let i=0;i<count;i++){
        const w = pickUnique('pron_word_local', pool);
        const sent = rand(templates)(w);
        const tag = `pron_sent:${hash32(normalize(sent))}`;
        if(hasSeen(tag)) { i--; continue; }
        remember(tag);
        sentences.push(sent);
      }
      return sentences;
    }

    const generatePracticeSet = async () => {
      const sents = await generatePracticeSentences(practiceTopic.value, 8);
      practiceList.value = sents.map((t, i) => ({ id: Date.now()+i, text: t, score:null, passed:false, transcript:'' }));
      currentIndex.value = 0;
      clearRecording();
      localStorage.setItem('ltult_pron_topic', practiceTopic.value || '');
    };

    async function ensureMic(){
      if(!mediaStream){ mediaStream = await navigator.mediaDevices.getUserMedia({ audio:true }); }
      return mediaStream;
    }

    function pickMimeType(){
      const preferred = ['audio/webm;codecs=opus','audio/webm','audio/ogg;codecs=opus','audio/ogg'];
      for(const t of preferred){
        if(window.MediaRecorder && MediaRecorder.isTypeSupported && MediaRecorder.isTypeSupported(t)) return t;
      }
      return '';
    }

    function stopRecorderSafe(){
      if(mediaRecorder && mediaRecorder.state !== 'inactive'){ try{ mediaRecorder.stop(); }catch{} }
    }

    function startSpeechRecognition(){
      lastTranscript.value = '';
      if(!speechSupported.value) return;
      recognition = new SpeechRecognition();
      recognition.lang = pronLang.value;
      recognition.continuous = false;
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;
      recognition.onresult = (event) => {
        const text = event.results?.[0]?.[0]?.transcript || '';
        lastTranscript.value = text;
      };
      recognition.onerror = () => {};
      recognition.onend = () => {};
      try{ recognition.start(); }catch{}
    }

    function stopSpeechRecognition(){
      if(recognition){ try{ recognition.stop(); }catch{} }
    }

    function evaluatePronunciation(){
      const target = currentItem.value.text || '';
      const spoken = lastTranscript.value || '';
      const score = speechSupported.value ? similarityPercent(target, spoken) : null;
      const passed = (score !== null) ? (score >= passThreshold.value) : false;
      const it = practiceList.value[currentIndex.value];
      if(it){ it.transcript = spoken; it.score = score; it.passed = passed; }
    }

    const clearRecording = () => {
      if(lastAudioUrl.value) URL.revokeObjectURL(lastAudioUrl.value);
      lastAudioUrl.value = '';
      lastTranscript.value = '';
      recStateLabel.value = 'Listo';
    };

    const toggleRecord = async () => {
      if(recBusy.value) return;
      recBusy.value = true;
      try{
        if(!isRecording.value){
          clearRecording();
          recStateLabel.value = 'Solicitando micr√≥fono...';
          const stream = await ensureMic();
          recordedChunks = [];
          const mimeType = pickMimeType();
          mediaRecorder = new MediaRecorder(stream, mimeType ? { mimeType } : undefined);
          mediaRecorder.ondataavailable = (e) => { if(e.data && e.data.size>0) recordedChunks.push(e.data); };
          mediaRecorder.onstart = () => { recStateLabel.value = 'Grabando...'; };
          mediaRecorder.onerror = () => { recStateLabel.value = 'Error al grabar'; };
          mediaRecorder.onstop = () => {
            const blob = new Blob(recordedChunks, { type: mimeType || 'audio/webm' });
            lastAudioUrl.value = URL.createObjectURL(blob);
            recStateLabel.value = 'Grabaci√≥n lista';
          };

          startSpeechRecognition();
          mediaRecorder.start();
          isRecording.value = true;
        } else {
          recStateLabel.value = 'Procesando...';
          stopRecorderSafe();
          stopSpeechRecognition();
          isRecording.value = false;
          await sleep(550);
          evaluatePronunciation();
        }
      } catch(e){
        recStateLabel.value = 'Permiso denegado o error';
      } finally {
        recBusy.value = false;
      }
    };

    // ===================== Init =====================
    onMounted(async () => {
      // load chat
      const savedMsgs = await localforage.getItem('messages');
      if(Array.isArray(savedMsgs) && savedMsgs.length){ messages.value = savedMsgs; }
      await loadNotebook();
      await loadVocab();

      setupInputPaddingObserver();

      // create practice set first time
      if(!practiceList.value.length) generatePracticeSet();

      // ensure scroll bottom if restored
      if(messages.value.length) scrollToBottom();
    });

    // cleanup
    window.addEventListener('beforeunload', () => {
      try{ voiceRec && voiceRec.stop(); }catch{}
      try{ stopRecorderSafe(); stopSpeechRecognition(); }catch{}
      if(lastAudioUrl.value) URL.revokeObjectURL(lastAudioUrl.value);
      localforage.setItem('messages', messages.value).catch(()=>{});
    });

    return {
      // core
      displayName, mode, modeLabel,
      messages, input, loading, showConfig, textarea,
      sessionId, useInternet, timeoutMs, internetOk,
      level, ttsLang,
      pronLang, passThreshold,
      notebook, vocab, vocabSearch, filteredVocab,
      sideOpen, sideTab,
      pyReady, pyLoading,
      isVoiceInput,

      // ui
      renderMD, statusLine,
      toggleSide, send, sendText, regenerate,
      tts, copy,
      toggleVoiceInput,

      // notebook/vocab
      pinToNotebook, clearNotebook, clearVocab,

      // config
      saveConfig, resetAll,

      // memory
      resetSeen,

      // python
      togglePython,

      // pronunciation
      speechSupported,
      practiceTopic, practiceList, currentIndex, currentItem,
      generatePracticeSet, nextPractice, prevPractice,
      resetPracticeScores,
      doneCount, overallScore, overallScoreColor,
      scoreColor, rowClass,
      ttsPractice,
      isRecording, recBusy, lastAudioUrl, lastTranscript,
      recStateLabel, toggleRecord, clearRecording
    };
  }
}).mount('#app');
</script>

</body>
</html>
